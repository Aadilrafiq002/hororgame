<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 GATES: INFERNAL</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #bc0000; --panel: #161616; }
        body { 
            background: var(--bg); color: #cfcfcf; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; text-align: center; overflow: hidden; touch-action: manipulation;
        }

        /* Auth Screen */
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #auth-screen input { padding: 15px; margin: 8px; width: 80%; max-width: 300px; background: #111; border: 1px solid #444; color: white; border-radius: 8px; }

        /* Identity Bar (Who is who) */
        #soul-map { 
            display: flex; justify-content: center; gap: 10px; padding: 10px; 
            background: #000; border-bottom: 2px solid var(--accent); flex-wrap: wrap;
        }
        .soul-card { background: #1a1a1a; padding: 4px 10px; border-radius: 5px; font-size: 14px; border: 1px solid #333; }
        .active-soul { border-color: var(--accent); background: #300; }

        /* Game Board */
        #game-container { 
            display: grid; grid-template-columns: repeat(10, 1fr); 
            width: 95vw; max-width: 450px; aspect-ratio: 1/1; 
            margin: 10px auto; border: 4px solid #333; background: #000; 
        }
        .cell { border: 0.1px solid #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 10px; position: relative; color: #444; }
        .player { width: 80%; height: 80%; z-index: 10; font-size: 20px; display: flex; align-items: center; justify-content: center; }

        /* Controls */
        .controls { width: 95vw; max-width: 450px; margin: 0 auto; }
        #roll-btn { 
            padding: 18px; width: 100%; border-radius: 12px; font-size: 20px; 
            font-weight: bold; cursor: pointer; border: none; margin-bottom: 10px;
        }
        .btn-active { background: #008000; color: white; box-shadow: 0 0 15px rgba(0,128,0,0.5); }
        .btn-wait { background: #222; color: #666; }

        /* Fixed Emoji Keyboard */
        #chat-window { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: #111; border-top: 2px solid var(--accent);
            padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }
        .emoji-bar { 
            display: flex; flex-wrap: wrap; justify-content: center; 
            gap: 8px; max-width: 600px; margin: 0 auto; 
        }
        .emoji-bar button { 
            font-size: 24px; padding: 10px; background: #222; 
            border: 1px solid #444; border-radius: 10px; flex: 1 0 15%; /* Ensures 5-6 per row */
            max-width: 50px; cursor: pointer;
        }

        /* Overlay */
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9000; padding: 20px; }
        .event-card { width: 100%; max-width: 400px; background: #111; border: 2px solid var(--accent); padding: 20px; border-radius: 15px; }
        #res-img { width: 100%; border-radius: 10px; margin-bottom: 15px; }

        #emoji-flash { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9500; pointer-events: none; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color:var(--accent); font-size: 40px; letter-spacing: 5px;">100 GATES</h1>
        <input type="text" id="user-name" placeholder="Name">
        <input type="password" id="admin-pass" placeholder="Admin Key">
        <button onclick="handleAuth()" style="width:80%; padding:15px; background:var(--accent); color:white; border:none; border-radius:10px; font-weight:bold;">ENTER VOID</button>
    </div>

    <div id="soul-map"></div>

    <div id="game-container"></div>

    <div class="controls">
        <div id="status-bar" style="color:gold; margin-bottom:5px; font-weight:bold;">CARDS: 0</div>
        <button id="roll-btn" class="btn-wait" onclick="playTurn()" disabled>WAITING...</button>
    </div>

    <div id="chat-window">
        <div class="emoji-bar">
            <button onclick="sendEmoji('üëª')">üëª</button><button onclick="sendEmoji('üíÄ')">üíÄ</button>
            <button onclick="sendEmoji('üò±')">üò±</button><button onclick="sendEmoji('üî•')">üî•</button>
            <button onclick="sendEmoji('üòà')">üòà</button><button onclick="sendEmoji('üòÇ')">üòÇ</button>
            <button onclick="sendEmoji('üëé')">üëé</button><button onclick="sendEmoji('ü§´')">ü§´</button>
            <button onclick="sendEmoji('üôè')">üôè</button><button onclick="sendEmoji('ü§°')">ü§°</button>
        </div>
    </div>

    <div id="overlay">
        <div class="event-card">
            <img id="res-img" src="">
            <h2 id="res-text"></h2>
            <div id="event-actions"></div>
        </div>
    </div>

    <div id="emoji-flash"><p id="flash-content" style="font-size:100px; margin:0;"></p><p id="flash-user" style="color:red; font-size: 20px;"></p></div>

<script>
    const ADMIN_USER = "aadil", ADMIN_PASS = "aadil123";
    const SYMBOLS = ["üêâ", "ü¶Å", "üêØ", "ü¶â"];
    let peer, hostConn, guestConns = [];
    let myRole = -1, isHost = false, turn = 0, positions = [1,1,1,1], maxPlayers = 2;
    let inventory = 0, finished = [false, false, false, false];
    let playerNames = [], playerSymbols = [];

    // Setup Board
    for (let i = 0; i < 100; i++) {
        let row = Math.floor(i / 10), col = i % 10, num;
        if (row % 2 === 0) num = 100 - (row * 10 + col); else num = 100 - (row * 10 + (9 - col));
        let cell = document.createElement('div'); cell.className = 'cell'; cell.id = 'cell-' + num; cell.innerText = num;
        document.getElementById('game-container').appendChild(cell);
    }

    function handleAuth() {
        const name = document.getElementById('user-name').value.trim();
        const pass = document.getElementById('admin-pass').value.trim();
        const rID = window.location.hash.substring(1);
        if(!name) return;
        if (name.toLowerCase() === ADMIN_USER && pass === ADMIN_PASS) {
            isHost = true; document.getElementById('auth-screen').style.display = 'none'; showHostUI();
        } else if (rID) {
            isHost = false; document.getElementById('auth-screen').style.display = 'none'; startAsGuest(rID, name);
        }
    }

    function showHostUI() {
        document.getElementById('soul-map').innerHTML = `
            <select id="p-count" style="padding:10px; background:#111; color:white; border:1px solid #444;">
                <option value="2">2 Players</option><option value="3">3 Players</option><option value="4">4 Players</option>
            </select>
            <button onclick="startAsHost()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:5px;">CREATE LINK</button>`;
    }

    function startAsHost() {
        maxPlayers = parseInt(document.getElementById('p-count').value);
        playerNames = [document.getElementById('user-name').value];
        playerSymbols = [...SYMBOLS].sort(() => Math.random() - 0.5);
        peer = new Peer();
        peer.on('open', id => {
            myRole = 0;
            const link = window.location.origin + window.location.pathname + '#' + id;
            document.getElementById('soul-map').innerHTML = `Lobby: <input value="${link}" readonly style="background:black; color:gold; border:none; width:150px;"> <button onclick="navigator.clipboard.writeText('${link}'); alert('Copied')">COPY</button>`;
        });
        peer.on('connection', c => {
            c.on('data', d => {
                if(d.type === 'join') { 
                    guestConns.push(c); playerNames.push(d.name);
                    if(guestConns.length === maxPlayers-1) sendInit(); 
                }
                handleData(d);
            });
        });
    }

    function startAsGuest(id, name) {
        peer = new Peer();
        peer.on('open', () => {
            hostConn = peer.connect(id);
            hostConn.on('open', () => hostConn.send({ type: 'join', name: name }));
            hostConn.on('data', d => handleData(d));
        });
    }

    function sendInit() {
        guestConns.forEach((c, i) => c.send({ type: 'init', role: i+1, max: maxPlayers, names: playerNames, syms: playerSymbols }));
        updateUI();
    }

    function handleData(d) {
        if (isHost) guestConns.forEach(c => { if(c.peer !== d.from) c.send(d); });
        if (d.type === 'init') { myRole = d.role; maxPlayers = d.max; playerNames = d.names; playerSymbols = d.syms; updateUI(); }
        if (d.type === 'sync') { positions = d.pos; turn = d.turn; updateUI(); }
        if (d.type === 'sab') { positions[d.to] = d.pos; updateUI(); }
        if (d.type === 'chat') showFlash(d);
    }

    function playTurn() {
        let roll = Math.floor(Math.random() * 6) + 1;
        positions[myRole] += roll;
        if (positions[myRole] >= 100) positions[myRole] = 100;
        
        if (Math.random() < 0.3) triggerEvent();
        else sync();
    }

    function triggerEvent() {
        const overlay = document.getElementById('overlay'), actions = document.getElementById('event-actions');
        overlay.style.display = "flex";
        let isTrap = Math.random() < 0.7;
        document.getElementById('res-img').src = (isTrap ? 'h' : 'f') + (Math.floor(Math.random()*5)+1) + ".jpg";
        document.getElementById('res-text').innerText = isTrap ? "TRAP TRIGGERED" : "LUCKY FIND";

        if (!isTrap) {
            inventory++;
            actions.innerHTML = `<button onclick="closeOverlay()" style="width:100%; padding:15px; background:green; color:white; border:none; border-radius:10px;">COLLECT CARD</button>`;
        } else {
            let btns = `<button onclick="takeHit()" style="width:100%; padding:15px; background:#444; color:white; border:none; border-radius:10px;">TAKE -10 GATES</button>`;
            if (inventory > 0) {
                playerNames.forEach((name, i) => {
                    if (i !== myRole) btns += `<button onclick="sabotage(${i})" style="margin-top:10px; width:100%; padding:15px; background:red; color:white; border:none; border-radius:10px;">PUNISH ${playerSymbols[i]}</button>`;
                });
            }
            actions.innerHTML = btns;
        }
    }

    function sabotage(target) {
        inventory--;
        let newPos = Math.max(1, positions[target] - 10);
        broadcast({ type: 'sab', to: target, pos: newPos });
        closeOverlay();
    }

    function takeHit() { positions[myRole] = Math.max(1, positions[myRole]-10); closeOverlay(); }
    function closeOverlay() { document.getElementById('overlay').style.display = "none"; sync(); }

    function broadcast(d) { d.from = peer.id; if(isHost) handleData(d); else hostConn.send(d); }
    function sync() { 
        do { turn = (turn + 1) % maxPlayers; } while(finished[turn]);
        broadcast({ type: 'sync', pos: positions, turn: turn }); 
        updateUI(); 
    }

    function updateUI() {
        // Update Soul Map
        const map = document.getElementById('soul-map'); map.innerHTML = "";
        playerNames.forEach((name, i) => {
            map.innerHTML += `<div class="soul-card ${turn === i ? 'active-soul' : ''}">${playerSymbols[i]} ${name}</div>`;
        });

        // Update Button
        const btn = document.getElementById('roll-btn');
        const active = (turn === myRole);
        btn.disabled = !active;
        btn.innerText = active ? `ROLL DICE (${playerSymbols[myRole]})` : `WAITING FOR ${playerSymbols[turn]}`;
        btn.className = active ? "btn-active" : "btn-wait";
        document.getElementById('status-bar').innerText = `CARDS: ${inventory}`;

        // Update Board
        document.querySelectorAll('.player').forEach(p => p.remove());
        positions.forEach((pos, i) => {
            const cell = document.getElementById('cell-' + pos);
            if (cell) {
                const p = document.createElement('div'); p.className = 'player';
                p.innerText = playerSymbols[i]; cell.appendChild(p);
            }
        });
    }

    function sendEmoji(e) { broadcast({ type: 'chat', text: e, sender: playerNames[myRole] }); }
    function showFlash(d) {
        const f = document.getElementById('emoji-flash');
        document.getElementById('flash-content').innerText = d.text;
        document.getElementById('flash-user').innerText = d.sender;
        f.style.display = "flex"; setTimeout(() => f.style.display = "none", 1200);
    }
</script>
</body>
</html>
