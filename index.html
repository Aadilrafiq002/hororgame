<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 GATES: INFERNAL EDITION</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #bc0000; --panel: #1a1a1a; --fire: #ff4500; }
        body { background: var(--bg); color: #cfcfcf; font-family: 'Courier New', monospace; margin: 0; text-align: center; overflow-x: hidden; touch-action: manipulation; }
        
        #conn-status { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: #555; z-index: 10000; }
        #conn-status.online { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        #conn-status.offline { background: #ff0000; }

        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #auth-screen input { padding: 12px; margin: 5px; width: 80%; max-width: 300px; background: #111; border: 1px solid #444; color: white; border-radius: 5px; }

        #soul-bar { display: flex; justify-content: center; gap: 10px; background: #111; padding: 8px; border-bottom: 1px solid #333; font-size: 11px; flex-wrap: wrap; }
        .soul-id { display: flex; align-items: center; gap: 5px; padding: 2px 8px; border-radius: 15px; background: #1a1a1a; border: 1px solid #333; }
        .soul-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .my-identity { border-color: var(--accent); background: #2a0000; }
        .active-turn { box-shadow: 0 0 10px gold; border-color: gold; color: gold; }

        #game-container { display: grid; grid-template-columns: repeat(10, 1fr); width: 95vw; max-width: 400px; aspect-ratio: 1/1; margin: 5px auto; border: 5px solid #333; background: #000; }
        .cell { border: 0.1px solid #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 10px; position: relative; background: #080808; color: #444; overflow: hidden; }
        .fire-glow { position: absolute; inset: 0; opacity: 0; background: radial-gradient(circle, rgba(255,69,0,0.3) 0%, transparent 70%); }

        .player { width: 16px; height: 16px; border-radius: 50%; position: absolute; border: 2px solid #000; z-index: 10; transition: all 0.2s linear; }
        .p0 { background: #ff3333; box-shadow: 0 0 10px #f00; } 
        .p1 { background: #33aaff; box-shadow: 0 0 10px #0af; } 
        .p2 { background: #33ff77; box-shadow: 0 0 10px #0f7; } 
        .p3 { background: #f0ff33; box-shadow: 0 0 10px #ff0; }
        
        #ritual-log { background: #000; color: #888; padding: 5px; font-size: 12px; height: 25px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #222;}
        .panel { background: var(--panel); padding: 8px; border-radius: 10px; width: 90%; max-width: 400px; border: 1px solid var(--accent); margin: 5px auto; }
        #roll-btn { padding: 12px; width: 100%; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; border: none; }
        .btn-active { background: #008000; color: white; }
        .btn-wait { background: #222; color: #555; }
        
        #chat-window { position: fixed; bottom: 0; left: 0; right: 0; background: #111; z-index: 8000; border-top: 2px solid var(--accent); padding-bottom: env(safe-area-inset-bottom); }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); max-width: 400px; margin: 0 auto; padding: 6px; gap: 5px; }
        .emoji-grid button { font-size: 22px; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 8px; cursor: pointer; }

        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9000; padding: 20px; }
        #emoji-flash { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9500; pointer-events: none; }
        .menu-btn { width: 80%; padding: 15px; margin: 5px; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; color: white; }
    </style>
</head>
<body>

    <div id="conn-status"></div>
    <audio id="bg-music" loop><source src="bg.mp3" type="audio/mpeg"></audio>

    <div id="auth-screen">
        <h1 style="color:var(--accent); font-size: 40px; letter-spacing: 5px;">100 GATES</h1>
        <div id="auth-inputs">
            <input type="text" id="user-name" placeholder="Name">
            <input type="password" id="admin-pass" placeholder="Admin Key">
            <button onclick="handleAuth()" class="menu-btn" style="background:var(--accent);">ENTER THE VOID</button>
        </div>
        <div id="mode-selection" style="display:none; width: 100%; flex-direction: column; align-items: center;">
            <button onclick="startVsCPU()" class="menu-btn" style="background:#444;">PLAY WITH COMPUTER</button>
            <button onclick="showLobbySettings()" class="menu-btn" style="background:var(--accent);">PLAY WITH FRIENDS</button>
        </div>
    </div>

    <div id="soul-bar"></div>
    <div id="emoji-flash"><p id="flash-content" style="font-size: 80px;"></p><p id="flash-user" style="color:red; font-size: 20px;"></p></div>

    <div id="setup-screen" style="position:fixed; inset:0; background:#000; z-index:8500; display:none; flex-direction:column; justify-content:center; align-items:center;">
        <div id="ui-box" class="panel"></div>
    </div>

    <div id="ritual-log">Summoning spirits...</div>
    <div id="game-container"></div>

    <div class="panel" style="margin-bottom: 130px;">
        <div id="dice-box" style="font-size: 20px; margin-bottom: 5px;">üé≤</div>
        <button id="roll-btn" class="btn-wait" onclick="playTurn()" disabled>WAITING...</button>
        <div id="inv-display" style="color:gold; font-size: 12px; font-weight:bold; margin-top:5px;">CARDS: 0 (0/5 USED)</div>
        <div id="host-controls" style="margin-top: 10px;"></div>
    </div>

    <div id="chat-window">
        <div class="emoji-grid">
            <button onclick="sendEmoji('üëª')">üëª</button><button onclick="sendEmoji('üíÄ')">üíÄ</button>
            <button onclick="sendEmoji('üò±')">üò±</button><button onclick="sendEmoji('üî•')">üî•</button>
            <button onclick="sendEmoji('üòà')">üòà</button><button onclick="sendEmoji('üòÇ')">üòÇ</button>
            <button onclick="sendEmoji('üôè')">üôè</button><button onclick="sendEmoji('ü§´')">ü§´</button>
            <button onclick="sendEmoji('üëé')">üëé</button><button onclick="sendEmoji('ü§°')">ü§°</button>
        </div>
    </div>

    <div id="overlay"><div class="panel" style="text-align:center;"><img id="res-img" src="" style="width:100%; max-height:30vh; object-fit:contain;"><h2 id="res-text"></h2><div id="event-actions"></div></div></div>

<script>
    const ADMIN_USER = "aadil";
    const ADMIN_PASS = "aadil123";

    let peer, hostConn, guestConns = [];
    let myRole = -1, isHost = false, turn = 0, positions = [1,1,1,1], maxPlayers = 2;
    let personalRolls = 0, inventory = { passes: 0, usedCount: 0 }, finished = [false, false, false, false];
    let playerNames = ["P1", "P2", "P3", "P4"];
    let isMoving = false;
    let isVsCPU = false;

    const jokes = [
        "Are you a turtle? Because you move so slow!",
        "Even my grandma reaches 100 faster than you!",
        "You're not losing, you're just winning in reverse!",
        "Did you trip on the first gate? Typical noob!",
        "I've seen snails with more speed than you!"
    ];

    const sounds = { dice: new Audio('dice.mp3'), jump: new Audio('jump.mp3'), noob: new Audio('noob.mp3') };
    function playSound(n) { const s = sounds[n]?.cloneNode(); s?.play().catch(()=>{}); }

    // --- INITIALIZATION ---
    function initPeer(id = null) {
        if (peer) peer.destroy();
        peer = id ? new Peer(id) : new Peer();
        peer.on('open', (newId) => {
            document.getElementById('conn-status').className = 'online';
            if (isHost) updateHostUI(window.location.origin + window.location.pathname + '#' + newId);
        });
        peer.on('disconnected', () => { document.getElementById('conn-status').className = 'offline'; peer.reconnect(); });
        if (isHost) setupHostListeners();
    }

    const boardEl = document.getElementById('game-container');
    const cells = [];
    for (let i = 0; i < 100; i++) {
        let row = Math.floor(i / 10), col = i % 10, num;
        if (row % 2 === 0) num = 100 - (row * 10 + col); else num = 100 - (row * 10 + (9 - col));
        let cell = document.createElement('div'); cell.className = 'cell'; cell.id = 'cell-' + num; cell.innerText = num;
        let glow = document.createElement('div'); glow.className = 'fire-glow'; cell.appendChild(glow);
        boardEl.appendChild(cell);
        cells.push(glow);
    }

    function flickerFire() {
        cells.forEach(c => { if (Math.random() < 0.05) { c.style.opacity = Math.random() * 0.8; setTimeout(() => { c.style.opacity = 0; }, 200 + Math.random() * 800); } });
        requestAnimationFrame(flickerFire);
    }
    flickerFire();

    // --- AUTH & LOBBY ---
    function handleAuth() {
        const name = document.getElementById('user-name').value.trim();
        const pass = document.getElementById('admin-pass').value.trim();
        const rID = window.location.hash.substring(1);
        const bgm = document.getElementById('bg-music');
        if(bgm) { bgm.volume = 0.4; bgm.play().catch(()=>{}); }
        if(!name) return;
        localStorage.setItem('gate_username', name);
        
        if (name.toLowerCase() === ADMIN_USER && pass === ADMIN_PASS) {
            document.getElementById('auth-inputs').style.display = 'none';
            document.getElementById('mode-selection').style.display = 'flex';
        } else if (rID) {
            isHost = false; document.getElementById('auth-screen').style.display = 'none'; startAsGuest(rID, name); 
        } else { alert("Admins Only or Join via Link!"); }
    }

    function startVsCPU() {
        isVsCPU = true; isHost = true; myRole = 0; maxPlayers = 2;
        playerNames[0] = localStorage.getItem('gate_username');
        playerNames[1] = "HELL_BOT";
        document.getElementById('auth-screen').style.display = 'none';
        updateUI();
    }

    function showLobbySettings() { isVsCPU = false; document.getElementById('auth-screen').style.display = 'none'; showHostUI(); }

    function showHostUI() {
        document.getElementById('setup-screen').style.display = 'flex';
        document.getElementById('ui-box').innerHTML = `<p style="color:red; font-weight:bold;">GATE KEEPER</p><select id="p-count" style="width:100%; padding:15px; background:#000; color:white;"><option value="2">2 Players</option><option value="3">3 Players</option><option value="4">4 Players</option></select><button onclick="startAsHost()" style="background:red; color:white; width:100%; margin-top:15px; padding:15px; border:none; font-weight:bold;">ACTIVATE GATE</button>`;
    }

    function startAsHost() {
        maxPlayers = parseInt(document.getElementById('p-count').value);
        playerNames[0] = localStorage.getItem('gate_username');
        myRole = 0; initPeer();
    }

    function updateHostUI(link) {
        document.getElementById('ui-box').innerHTML = `<p>SHARE LINK:</p><input type="text" value="${link}" id="lInp" readonly style="width:100%; padding:8px; background:#000; color:white;"><button onclick="copyL()" style="width:100%; margin-top:10px;">COPY & WHATSAPP</button><button onclick="sendInit()" style="background:green; color:white; width:100%; margin-top:15px; padding:10px; border:none; font-weight:bold;">FORCE START</button>`;
    }

    // --- GAMEPLAY CORE ---
    async function animateMove(playerIdx, targetPos) {
        isMoving = true;
        let current = positions[playerIdx];
        const step = targetPos > current ? 1 : -1;
        while (current !== targetPos) {
            current += step;
            positions[playerIdx] = current;
            refreshBoardOnly();
            await new Promise(r => setTimeout(r, 150)); 
        }
        updateUI();
    }

    // HUMAN TURN
    async function playTurn() {
        if(finished[myRole] || isMoving) return;
        isMoving = true;
        playSound('dice');
        let roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-box').innerText = "üé≤ " + roll;
        let target = Math.min(100, positions[myRole] + roll);
        await animateMove(myRole, target);
        personalRolls++;

        if (positions[myRole] >= 100) { 
            finished[myRole] = true;
            isMoving = false;
            if(!isVsCPU) broadcast({ type: 'finish', winner: myRole });
            handleJudgment(myRole);
            return; 
        }

        if (personalRolls >= 2 || Math.random() < 0.30) {
            personalRolls = 0;
            triggerHumanResult(); 
        } else {
            isMoving = false;
            sync(`${playerNames[myRole]} moved`);
        }
    }

    // BOT TURN
    async function botTurn() {
        if (finished[1] || isMoving || turn !== 1) return;
        isMoving = true;
        document.getElementById('ritual-log').innerText = "HELL_BOT is rolling...";
        await new Promise(r => setTimeout(r, 1200));
        
        let roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-box').innerText = "üé≤ " + roll;
        playSound('dice');
        
        let target = Math.min(100, positions[1] + roll);
        await animateMove(1, target);

        if (positions[1] >= 100) {
            finished[1] = true;
            isMoving = false;
            handleJudgment(1);
            return;
        }

        // Bot processes event immediately without overlay
        applyBotEvent();
    }

    async function applyBotEvent() {
        let rand = Math.random() * 100;
        let msg = "Bot finished turn";
        if (rand < 15) {
            positions[1] = Math.max(1, positions[1] - 10);
            msg = "BOT hit a trap!";
        } else if (rand < 30) {
            positions[1] = Math.min(100, positions[1] + 5);
            msg = "BOT was blessed!";
        } else if (rand < 40) {
            positions[1] = 1;
            msg = "BOT banised to VOID!";
        }
        
        refreshBoardOnly();
        await new Promise(r => setTimeout(r, 800));
        isMoving = false;
        sync(msg);
    }

    function triggerHumanResult() {
        const overlay = document.getElementById('overlay');
        const text = document.getElementById('res-text');
        const actions = document.getElementById('event-actions');
        const img = document.getElementById('res-img');
        overlay.style.display = "flex";
        
        let r = Math.random() * 100;
        if (r < 15) {
            img.src = "https://img.icons8.com/emoji/96/000000/cyclone-emoji.png";
            text.innerHTML = "THE VOID<br><small>Go back to gate 1.</small>";
            actions.innerHTML = `<button onclick="takeVoid()" style="background:purple; color:white; padding:10px; width:100%; border:none;">ACCEPT FATE</button>`;
        } else if (r < 40) {
            inventory.passes++;
            img.src = "https://img.icons8.com/emoji/96/000000/joker.png";
            text.innerHTML = "SABOTAGE CARD<br><small>Drag someone back.</small>";
            let targets = "";
            playerNames.slice(0, maxPlayers).forEach((name, i) => {
                if (i !== myRole && !finished[i]) targets += `<button onclick="useSabotage(${i}, 10)" style="background:red; color:white; padding:5px; margin:2px;">DRAG ${name}</button>`;
            });
            actions.innerHTML = targets || `<button onclick="closeOverlaySync('Collected Card')">COLLECT</button>`;
        } else if (r < 70) {
            img.src = "https://img.icons8.com/emoji/96/000000/fire.png";
            text.innerHTML = "INFERNO GATES<br><small>Burned back 8 gates.</small>";
            actions.innerHTML = `<button onclick="takePenalty(8)" style="background:orange; color:white; padding:10px; width:100%; border:none;">BURN</button>`;
        } else {
            img.src = "https://img.icons8.com/emoji/96/000000/sparkles.png";
            text.innerHTML = "DEMONIC BLESSING<br><small>Move forward 6 gates.</small>";
            actions.innerHTML = `<button onclick="takeReward(6)" style="background:green; color:white; padding:10px; width:100%; border:none;">RISE</button>`;
        }
    }

    // --- UTILITIES ---
    function refreshBoardOnly() {
        document.querySelectorAll('.player').forEach(p => p.remove());
        positions.slice(0, maxPlayers).forEach((pos, i) => {
            const cell = document.getElementById('cell-' + pos);
            if (cell) {
                const dot = document.createElement('div');
                dot.className = `player p${i}`;
                cell.appendChild(dot);
            }
        });
    }

    function sync(msg) { 
        nextTurn(); 
        if(!isVsCPU) {
            const d = { type: 'sync', pos: positions, turn: turn, msg: msg, fin: finished }; 
            if (isHost) broadcast(d); else hostConn.send(d); 
        } else {
            document.getElementById('ritual-log').innerText = msg;
        }
        updateUI(); 
    }
    
    function nextTurn() { 
        let activePlayers = finished.slice(0, maxPlayers).filter(f => !f).length;
        if(activePlayers <= 1) return; 
        do { turn = (turn + 1) % maxPlayers; } while (finished[turn]); 
    }

    function updateUI() {
        const active = (turn === myRole && !finished[myRole] && !isMoving);
        const btn = document.getElementById('roll-btn');
        btn.disabled = !active;
        if(finished[myRole]) btn.innerText = "SPECTATING...";
        else btn.innerText = active ? "ROLL DICE" : (isMoving ? "MOVING..." : playerNames[turn].toUpperCase() + "'S TURN");
        btn.className = active ? "btn-active" : "btn-wait";
        
        document.getElementById('inv-display').innerText = `CARDS: ${inventory.passes} (${inventory.usedCount}/5 USED)`;
        
        const sBar = document.getElementById('soul-bar'); sBar.innerHTML = "";
        playerNames.slice(0, maxPlayers).forEach((name, i) => {
            const div = document.createElement('div');
            div.className = `soul-id ${i === myRole ? 'my-identity' : ''} ${i === turn ? 'active-turn' : ''}`;
            div.innerHTML = `<span class="soul-dot p${i}"></span> ${finished[i] ? 'üèÅ ' : ''}${name}`;
            sBar.appendChild(div);
        });

        refreshBoardOnly();
        if (isVsCPU && turn === 1 && !finished[1] && !isMoving) botTurn();
    }

    async function takePenalty(p) { document.getElementById('overlay').style.display = "none"; await animateMove(myRole, Math.max(1, positions[myRole] - p)); isMoving = false; sync(`Burned!`); }
    async function takeReward(r) { document.getElementById('overlay').style.display = "none"; await animateMove(myRole, Math.min(100, positions[myRole] + r)); isMoving = false; sync(`Blessed!`); }
    async function takeVoid() { document.getElementById('overlay').style.display = "none"; await animateMove(myRole, 1); isMoving = false; sync(`Banished to Void!`); }

    function handleJudgment(winnerIdx) {
        const overlay = document.getElementById('overlay');
        const text = document.getElementById('res-text');
        overlay.style.display = "flex";
        if (myRole === winnerIdx) { 
            document.getElementById('res-img').src = "https://img.icons8.com/emoji/96/000000/trophy-emoji.png";
            text.innerHTML = `<span style="color:gold;">üèÜ ESCAPED! üèÜ</span>`; 
        } else { 
            playSound('noob');
            document.getElementById('res-img').src = "https://img.icons8.com/emoji/96/000000/skull-emoji.png";
            text.innerHTML = `<span style="color:red;">üíÄ LOST! üíÄ</span><br><small>${playerNames[winnerIdx]} won.</small>`; 
        }
        document.getElementById('event-actions').innerHTML = `<button onclick="location.reload()" style="padding:10px; background:red; color:white; border:none; width:100%;">BACK TO MENU</button>`;
    }

    // --- NETWORK LISTENERS ---
    function setupHostListeners() {
        peer.on('connection', c => {
            c.on('data', d => {
                if(d.type === 'join_request') {
                    if (guestConns.length < maxPlayers - 1) { 
                        guestConns.push(c); 
                        playerNames[guestConns.length] = d.name; 
                        if(guestConns.length === maxPlayers-1) sendInit(); 
                    }
                }
                handleData(d);
            });
        });
    }

    function startAsGuest(id, myName) { 
        peer = new Peer(); 
        peer.on('open', () => { 
            document.getElementById('conn-status').className = 'online';
            hostConn = peer.connect(id, {reliable: true}); 
            hostConn.on('open', () => { hostConn.send({ type: 'join_request', name: myName }); });
            hostConn.on('data', d => handleData(d)); 
        }); 
    }

    async function handleData(d) {
        if (isHost) guestConns.forEach(c => { if(c && c.peer !== d.fromPeer) c.send(d); });
        if (d.type === 'chat') {
            const f = document.getElementById('emoji-flash');
            document.getElementById('flash-content').innerText = d.text; document.getElementById('flash-user').innerText = d.sender;
            f.style.display = "flex"; setTimeout(() => f.style.display = "none", 1500);
        }
        if (d.type === 'sabotage') { await animateMove(d.to, d.newPos); updateUI(); }
        if (d.type === 'sync') { if(!isMoving) positions = d.pos; turn = d.turn; document.getElementById('ritual-log').innerText = d.msg; updateUI(); }
        if (d.type === 'init') { myRole = d.role; maxPlayers = d.max; positions = d.pos; turn = d.turn; finished = d.fin; playerNames = d.names; document.getElementById('setup-screen').style.display = 'none'; updateUI(); }
        if (d.type === 'finish') { finished[d.winner] = true; updateUI(); handleJudgment(d.winner); }
    }

    function broadcast(d) { handleData(d); guestConns.forEach(c => { if(c) c.send(d); }); }
    function copyL() { const i = document.getElementById('lInp'); i.select(); navigator.clipboard.writeText(i.value); alert("Link Copied!"); }
    function sendEmoji(e) { const m = { type: 'chat', sender: playerNames[myRole], text: e, fromPeer: peer.id }; if (isHost) broadcast(m); else hostConn.send(m); }
    function sendInit() { guestConns.forEach((c, i) => { if(c) c.send({ type: 'init', role: i+1, max: maxPlayers, pos: positions, turn: turn, fin: finished, names: playerNames }) }); document.getElementById('setup-screen').style.display = 'none'; updateUI(); }
</script>
</body>
</html>
