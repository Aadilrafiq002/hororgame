<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 GATES: SABOTAGE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #bc0000; --panel: #1a1a1a; }
        body { background: var(--bg); color: #cfcfcf; font-family: 'Courier New', monospace; margin: 0; text-align: center; overflow: hidden; touch-action: manipulation; }
        #game-container { display: grid; grid-template-columns: repeat(10, 1fr); width: 95vw; max-width: 380px; aspect-ratio: 1/1; margin: 5px auto; border: 4px solid #333; background: #222; }
        .cell { border: 0.1px solid #222; display: flex; align-items: center; justify-content: center; font-size: 10px; position: relative; }
        .player { width: 18px; height: 18px; border-radius: 50%; position: absolute; border: 2px solid #000; transition: 0.5s; z-index: 10; }
        .p0 { background: #ff3333; } .p1 { background: #33aaff; } .p2 { background: #33ff77; } .p3 { background: #f0ff33; }
        
        #emoji-flash { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9000; pointer-events: none; }
        
        .panel { background: var(--panel); padding: 8px; border-radius: 10px; width: 90%; max-width: 400px; border: 1px solid var(--accent); margin: 5px auto; }
        #roll-btn { padding: 12px; width: 100%; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; border: none; }
        .btn-active { background: #008000; color: white; } 
        .btn-wait { background: #333; color: #666; }

        #overlay, #judgement-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 3000; padding: 20px; }
        
        /* Event Boxes for Mid-Game Traps */
        .display-box { width: 280px; padding: 20px; border: 4px solid gold; border-radius: 15px; background: #111; }
        .trap-border { border-color: red !important; }

        /* Judgement Text Styles */
        #j-title { font-size: 40px; margin: 10px 0; font-weight: 900; }
        #j-joke { font-size: 18px; line-height: 1.4; padding: 0 20px; }

        #chat-window { position: fixed; bottom: 0; left: 0; width: 100%; background: #111; z-index: 2000; border-top: 2px solid var(--accent); }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); padding: 10px; gap: 5px; }
        .emoji-grid button { font-size: 22px; padding: 10px; background: #222; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="emoji-flash"><p id="flash-content" style="font-size:100px;"></p><p id="flash-user" style="color:red;"></p></div>

    <div id="judgement-screen">
        <div id="j-emoji" style="font-size: 120px;"></div>
        <h1 id="j-title"></h1>
        <p id="j-joke"></p>
        <button onclick="location.reload()" style="background:white; padding:20px; margin-top:30px; font-weight:bold; width:220px; border:none; border-radius: 50px; cursor:pointer;">RESTART RITUAL</button>
    </div>

    <div id="setup-screen" style="position:fixed; inset:0; background:#000; z-index:8000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 style="color:var(--accent); font-size: 45px; letter-spacing: 5px;">100 GATES</h1>
        <div id="ui-box" class="panel"><button onclick="unlockAudio()" style="width:100%; padding:15px; font-weight:bold;">ENTER THE VOID</button></div>
    </div>

    <div id="ritual-log" style="font-size: 13px; height: 20px; margin: 10px 0; color: #888;">Preparing the gates...</div>
    <div id="inv-display" style="color:gold; font-weight:bold; margin-bottom: 5px;">SABOTAGE CARDS: 0</div>
    
    <div id="game-container"></div>
    <div class="panel" style="margin-bottom: 120px;"><button id="roll-btn" class="btn-wait" onclick="playTurn()" disabled>WAITING...</button></div>

    <div id="chat-window">
        <div class="emoji-grid">
            <button onclick="sendEmoji('ðŸ‘»')">ðŸ‘»</button><button onclick="sendEmoji('ðŸ’€')">ðŸ’€</button>
            <button onclick="sendEmoji('ðŸ˜±')">ðŸ˜±</button><button onclick="sendEmoji('ðŸ˜‚')">ðŸ˜‚</button>
            <button onclick="sendEmoji('ðŸ¤¡')">ðŸ¤¡</button>
        </div>
    </div>

    <div id="overlay"></div>

<script>
    let peer, hostConn, guestConns = [];
    let myRole = -1, isHost = false, turn = 0, positions = [1,1,1,1], maxPlayers = 2;
    let personalTurnCounter = 0, inventory = { passes: 0 };

    const sounds = { dice: new Audio('dice.mp3'), jump: new Audio('jump.mp3'), noob: new Audio('noob.mp3') };
    function playSound(n) { const s = sounds[n].cloneNode(); s.play().catch(()=>{}); }

    function unlockAudio() {
        playSound('dice');
        const rID = window.location.hash.substring(1);
        if (rID) startAsGuest(rID); else showHostUI();
    }

    function showHostUI() {
        document.getElementById('ui-box').innerHTML = `
            <select id="p-count" style="width:100%; padding:10px; margin-bottom:10px;"><option value="2">2 Players</option><option value="3">3 Players</option><option value="4">4 Players</option></select>
            <button onclick="startAsHost()" style="background:red; color:white; width:100%; padding:10px; border:none; font-weight:bold;">HOST GAME</button>`;
    }

    function startAsHost() {
        isHost = true; maxPlayers = parseInt(document.getElementById('p-count').value);
        peer = new Peer();
        peer.on('open', (id) => { 
            myRole = 0; const link = window.location.origin + window.location.pathname + '#' + id;
            document.getElementById('ui-box').innerHTML = `<p style="font-size:11px;">SEND THIS TO FRIENDS:</p><input type="text" value="${link}" id="lInp" readonly style="width:100%; margin-bottom:10px;"><button onclick="copyL()" style="width:100%; padding:5px;">COPY LINK</button>`;
        });
        peer.on('connection', (c) => { 
            guestConns.push(c); 
            c.on('data', d => handleData(d)); 
            if(guestConns.length === maxPlayers-1) setTimeout(sendInit, 1000); 
        });
    }

    function startAsGuest(id) { 
        peer = new Peer(); 
        peer.on('open', () => { hostConn = peer.connect(id); hostConn.on('data', d => handleData(d)); }); 
    }

    function playTurn() {
        playSound('dice');
        let roll = Math.floor(Math.random() * 6) + 1;
        positions[myRole] += roll;
        personalTurnCounter++;
        if (positions[myRole] >= 100) { positions[myRole] = 100; sync(`P${myRole+1} IS THE ULTIMATE SURVIVOR!`, myRole); return; }
        
        if (personalTurnCounter >= 2) {
            personalTurnCounter = 0;
            triggerResult();
        } else {
            sync(`P${myRole+1} rolled ${roll}`);
        }
    }

    function triggerResult() {
        const overlay = document.getElementById('overlay');
        overlay.style.display = "flex";
        
        // Mid-game traps still use images as requested before (f1-5, h1-5)
        // If you want these removed too, let me know!
        if (Math.random() < 0.6) { // 60% TRAP
            playSound('jump');
            let passButtons = "";
            if (inventory.passes > 0) {
                for (let i=0; i<maxPlayers; i++) if(i!==myRole) passButtons += `<button onclick="usePass(${i})" style="background:purple; color:white; margin:5px; padding:10px; border:none; border-radius:5px;">SABOTAGE P${i+1}</button>`;
            }
            overlay.innerHTML = `
                <div class="display-box trap-border">
                    <img src="h${Math.floor(Math.random()*5)+1}.jpg" style="width:100%; border-radius:10px;">
                    <h2 style="color:red;">CURSED!</h2><p>Pushed back 10 steps.</p>
                    <button onclick="takePunishment()" style="background:white; color:black; padding:12px; width:100%; font-weight:bold; border:none; border-radius:5px;">ACCEPT</button>
                    ${passButtons}
                </div>
            `;
        } else { // 40% LOOT
            inventory.passes++;
            overlay.innerHTML = `
                <div class="display-box">
                    <img src="f${Math.floor(Math.random()*5)+1}.jpg" style="width:100%; border-radius:10px;">
                    <h2 style="color:gold;">LOOT!</h2><p>You found a Sabotage Card.</p>
                    <button onclick="closeOverlaySync('P${myRole+1} found a card')" style="background:gold; color:black; padding:12px; width:100%; font-weight:bold; border:none; border-radius:5px;">COLLECT</button>
                </div>
            `;
        }
        updateUI();
    }

    function usePass(target) {
        inventory.passes--;
        document.getElementById('overlay').style.display = "none";
        const d = { type: 'sabotage', to: target, msg: `P${myRole+1} USED A CARD ON P${target+1}!` };
        if (isHost) broadcast(d); else hostConn.send(d);
    }

    function takePunishment() {
        positions[myRole] = Math.max(1, positions[myRole]-10);
        document.getElementById('overlay').style.display = "none";
        playSound('noob');
        sync(`P${myRole+1} hit a trap!`);
    }

    function showJudgement(winIdx) {
        const screen = document.getElementById('judgement-screen');
        const emoji = document.getElementById('j-emoji');
        const title = document.getElementById('j-title');
        const joke = document.getElementById('j-joke');
        
        screen.style.display = "flex";
        
        if (winIdx === myRole) {
            emoji.innerText = "ðŸ†";
            title.innerText = "VICTORY!";
            title.style.color = "gold";
            joke.innerText = "Congratulations! You escaped the 100 Gates while everyone else is still wandering in the dark. You're officially too good for this game! ðŸ‘‘";
        } else {
            playSound('noob');
            emoji.innerText = "ðŸ’€";
            title.innerText = "NOOB ALERT!";
            title.style.color = "red";
            joke.innerText = "Ouch! You lost. Don't worry, the Gates will keep you warm tonight. Maybe try rolling the dice with your eyes open next time? ðŸ¤¡";
        }
    }

    function sendEmoji(e) {
        const m = { type: 'chat', sender: `P${myRole+1}`, text: e };
        if (isHost) broadcast(m); else hostConn.send(m);
    }

    function handleData(d) {
        if (isHost) { guestConns.forEach(c => { if(c.peer !== d.fromPeer) c.send(d); }); }
        if (d.type === 'chat') {
            const f = document.getElementById('emoji-flash');
            document.getElementById('flash-content').innerText = d.text;
            document.getElementById('flash-user').innerText = d.sender;
            f.style.display = "flex";
            if(d.text === 'ðŸ¤¡') playSound('noob');
            setTimeout(() => f.style.display = "none", 1500);
        }
        if (d.type === 'init') { myRole = d.role; maxPlayers = d.max; positions = d.pos; turn = d.turn; document.getElementById('setup-screen').style.display = 'none'; updateUI(); }
        if (d.type === 'sync') { 
            positions = d.pos; turn = d.turn; document.getElementById('ritual-log').innerText = d.msg; 
            if(d.winner !== -1) showJudgement(d.winner);
            updateUI(); 
        }
        if (d.type === 'sabotage') { 
            positions[d.to] = Math.max(1, positions[d.to]-10); 
            if(d.to === myRole) playSound('noob');
            document.getElementById('ritual-log').innerText = d.msg; 
            updateUI(); 
        }
    }

    function broadcast(d) { handleData(d); guestConns.forEach(c => c.send(d)); }

    function sync(msg, win = -1) {
        if (win === -1) turn = (turn + 1) % maxPlayers;
        const d = { type: 'sync', pos: positions, turn: turn, msg: msg, winner: win };
        if (isHost) broadcast(d); else hostConn.send(d);
        if (win !== -1) showJudgement(win);
    }

    function updateUI() {
        const active = (turn === myRole);
        const btn = document.getElementById('roll-btn');
        btn.disabled = !active;
        btn.innerText = active ? "ROLL DICE" : `WAITING FOR P${turn+1}`;
        btn.className = active ? "btn-active" : "btn-wait";
        document.getElementById('inv-display').innerText = `SABOTAGE CARDS: ${inventory.passes}`;
        
        document.querySelectorAll('.player').forEach(p => p.remove());
        positions.slice(0, maxPlayers).forEach((pos, i) => {
            const cell = document.getElementById('cell-' + pos);
            if (cell) {
                const dot = document.createElement('div');
                dot.className = `player p${i}`;
                cell.appendChild(dot);
            }
        });
    }

    function closeOverlaySync(m) { document.getElementById('overlay').style.display="none"; sync(m); }
    function copyL() { const i = document.getElementById('lInp'); i.select(); navigator.clipboard.writeText(i.value); alert("Link Copied!"); }
    function sendInit() { guestConns.forEach((c, i) => c.send({ type: 'init', role: i+1, max: maxPlayers, pos: positions, turn: turn })); document.getElementById('setup-screen').style.display = 'none'; updateUI(); }

    const board = document.getElementById('game-container');
    for (let i = 0; i < 100; i++) {
        let row = Math.floor(i / 10), col = i % 10, num;
        if (row % 2 === 0) num = 100 - (row * 10 + col); else num = 100 - (row * 10 + (9 - col));
        let cell = document.createElement('div'); cell.className = 'cell'; cell.id = 'cell-' + num; cell.innerText = num;
        board.appendChild(cell);
    }
</script>
</body>
</html>
