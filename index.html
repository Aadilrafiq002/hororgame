<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 GATES: FORCE CONNECT</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #8b0000; --panel: #1a1a1a; }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg); color: #ddd; font-family: 'Courier New', monospace; 
            margin: 0; padding: 5px; display: flex; flex-direction: column; align-items: center;
            overflow: hidden; touch-action: manipulation;
        }
        #game-wrapper {
            width: 95vw; max-width: 450px; aspect-ratio: 1 / 1;
            border: 5px solid #222; display: flex; flex-wrap: wrap-reverse; background: #111;
        }
        .cell { 
            width: 10%; height: 10%; border: 0.5px solid #222;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; position: relative; color: #444;
        }
        .player { 
            width: 16px; height: 16px; border-radius: 50%; position: absolute; 
            z-index: 10; border: 2px solid #fff; transition: all 0.5s ease; 
        }
        .p0 { background: #ff3333; box-shadow: 0 0 10px #f00; }
        .p1 { background: #33ffff; box-shadow: 0 0 10px #0ff; }
        .p2 { background: #33ff33; box-shadow: 0 0 10px #0f0; }
        .p3 { background: #ffff33; box-shadow: 0 0 10px #ff0; }
        .container { width: 95%; max-width: 450px; margin-top: 15px; }
        .panel { background: var(--panel); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        button { 
            background: var(--accent); color: white; border: none; padding: 18px; 
            cursor: pointer; font-weight: bold; width: 100%; border-radius: 5px; font-size: 20px;
        }
        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; display: none; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 3000; 
        }
        .setup-screen { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #000; z-index: 4000; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; padding: 20px; text-align: center;
        }
    </style>
</head>
<body>

    <div id="setup-screen" class="setup-screen">
        <h1 style="color:var(--accent); font-size: 40px;">100 GATES</h1>
        <div id="setup-controls">
            <select id="max-players-select" style="background:#111; color:white; padding:10px; margin:10px;">
                <option value="2">2 PLAYERS</option>
                <option value="3">3 PLAYERS</option>
                <option value="4">4 PLAYERS</option>
            </select><br>
            <button onclick="initHost()">HOST GAME</button>
        </div>
        <div id="waiting-area" style="display:none;">
            <p>COPY THIS LINK:</p>
            <input type="text" id="share-url" style="width:100%; padding:10px; background:#111; color:red;" readonly>
            <p id="player-count-display" style="font-size: 20px; color:red;"></p>
        </div>
    </div>

    <div id="status">OFFLINE</div>
    <div id="game-wrapper"></div>

    <div class="container">
        <div class="panel">
            <div id="dice-val" style="font-size: 40px;">ðŸŽ²</div>
            <button id="roll-btn" onclick="handleRoll()" disabled>ROLL DICE</button>
        </div>
    </div>

    <div id="overlay">
        <img id="scare-img" src="https://media.giphy.com/media/3o7TKqnN349PBUtGFO/giphy.gif" style="width:80%">
        <h2 id="event-text" style="color:red"></h2>
        <button onclick="closeOverlay()">CONTINUE</button>
    </div>

<script>
    let peer, conns = [];
    let positions = [1, 1, 1, 1], turn = 0, isHost = false, myRole = 0, maxPlayers = 2;
    let bgSnd, jumpSnd, diceSnd;

    // This config helps bypass firewalls/mobile data restrictions
    const peerConfig = {
        config: {
            'iceServers': [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' }
            ]
        }
    };

    function loadAudio() {
        bgSnd = new Audio('horrorsound.mp3'); bgSnd.loop = true; bgSnd.volume = 0.2;
        jumpSnd = new Audio('jump.mp3'); diceSnd = new Audio('dice.mp3');
        bgSnd.play().catch(() => {});
    }

    const hash = window.location.hash.replace('#', '');
    if (hash) {
        document.getElementById('setup-controls').innerHTML = "<button onclick='initGuest()'>JOIN GAME</button>";
    }

    function initHost() {
        isHost = true;
        maxPlayers = parseInt(document.getElementById('max-players-select').value);
        // Apply firewall fix
        peer = new Peer(peerConfig);
        peer.on('open', (id) => {
            document.getElementById('setup-controls').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
            document.getElementById('share-url').value = window.location.href + '#' + id;
            document.getElementById('player-count-display').innerText = `SOULS: 1 / ${maxPlayers}`;
            loadAudio();
        });
        peer.on('connection', (c) => {
            conns.push(c);
            setupConn(c);
            document.getElementById('player-count-display').innerText = `SOULS: ${conns.length + 1} / ${maxPlayers}`;
            if (conns.length === maxPlayers - 1) startGame();
        });
        peer.on('error', (err) => alert("Connection Error: " + err.type));
    }

    function initGuest() {
        // Apply firewall fix
        peer = new Peer(peerConfig);
        peer.on('open', () => {
            const conn = peer.connect(hash, {reliable: true});
            setupConn(conn);
            loadAudio();
        });
        peer.on('error', (err) => alert("Join Error: " + err.type));
    }

    function setupConn(c) {
        c.on('open', () => {
            if(!isHost) document.getElementById('status').innerText = "CONNECTED";
        });
        c.on('data', (data) => {
            if (data.type === 'init') {
                myRole = data.role; maxPlayers = data.max;
                document.getElementById('setup-screen').style.display = 'none';
                updateUI();
            }
            if (data.type === 'game') {
                positions = data.positions; turn = data.turn;
                updateUI();
            }
        });
    }

    function createBoard() {
        const wrapper = document.getElementById('game-wrapper');
        for (let row = 0; row < 10; row++) {
            for (let col = 0; col < 10; col++) {
                let num = (row % 2 === 0) ? (row * 10) + (col + 1) : (row * 10) + (10 - col);
                const cell = document.createElement('div');
                cell.className = 'cell'; cell.id = 'cell-' + num; cell.innerText = num;
                wrapper.appendChild(cell);
            }
        }
    }

    function startGame() {
        conns.forEach((c, i) => c.send({type: 'init', role: i + 1, max: maxPlayers}));
        document.getElementById('setup-screen').style.display = 'none';
        updateUI();
    }

    function handleRoll() {
        if(diceSnd) diceSnd.play();
        const roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-val').innerText = roll;
        let nextPos = positions[myRole] + roll;
        if (nextPos > 100) nextPos = 100 - (nextPos - 100);
        positions[myRole] = nextPos;
        updateUI();
        if (nextPos === 100) { alert("ESCAPED!"); location.reload(); }
        else if (nextPos > 1 && Math.random() > 0.6) setTimeout(triggerSurprise, 500);
        else finishTurn();
    }

    function triggerSurprise() {
        const surprises = [{t: "BACK 7!", m: -7}, {t: "FORWARD 10!", m: 10}, {t: "RESET!", abs: 1}];
        const s = surprises[Math.floor(Math.random() * surprises.length)];
        document.getElementById('event-text').innerText = s.t;
        document.getElementById('overlay').style.display = 'flex';
        if(jumpSnd) jumpSnd.play();
        if (s.abs) positions[myRole] = s.abs;
        else positions[myRole] = Math.max(1, Math.min(99, positions[myRole] + s.m));
    }

    function finishTurn() {
        turn = (turn + 1) % maxPlayers;
        sync();
        updateUI();
    }

    function sync() {
        const payload = {type: 'game', positions, turn};
        if (isHost) conns.forEach(c => c.send(payload));
        else {
            const hostConn = peer.connect(hash);
            hostConn.on('open', () => hostConn.send(payload));
        }
    }

    function updateUI() {
        document.getElementById('status').innerText = (turn === myRole) ? "YOUR TURN" : "WAITING...";
        document.getElementById('roll-btn').disabled = (turn !== myRole);
        document.querySelectorAll('.player').forEach(p => p.remove());
        positions.slice(0, maxPlayers).forEach((pos, i) => {
            const cell = document.getElementById('cell-' + pos);
            if(cell) {
                const p = document.createElement('div');
                p.className = `player p${i}`; cell.appendChild(p);
            }
        });
    }

    function closeOverlay() {
        document.getElementById('overlay').style.display = 'none';
        finishTurn();
    }

    createBoard();
</script>
</body>
</html>