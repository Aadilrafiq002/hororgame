<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 Gates of Horror</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #8b0000; --panel: #1a1a1a; --cell-size: 9.2vw; }
        @media (min-width: 600px) { :root { --cell-size: 50px; } }

        body { 
            background: var(--bg); color: #ddd; font-family: 'Courier New', monospace; 
            margin: 0; padding: 5px; display: flex; flex-direction: column; align-items: center;
            touch-action: manipulation; overflow-x: hidden;
        }

        /* Board Styling */
        #board { 
            display: grid; grid-template-columns: repeat(10, var(--cell-size)); 
            gap: 1px; border: 2px solid #444; background: #222; 
        }
        .cell { 
            width: var(--cell-size); height: var(--cell-size); 
            background: #111; display: flex; align-items: center; 
            justify-content: center; font-size: 9px; position: relative; border: 0.1px solid #222;
        }
        
        /* Player Tokens */
        .player { 
            width: 10px; height: 10px; border-radius: 50%; position: absolute; 
            z-index: 10; border: 1px solid #fff; transition: all 0.6s ease-in-out; 
        }
        .p0 { background: #ff3333; box-shadow: 0 0 8px #f00; }
        .p1 { background: #33ffff; box-shadow: 0 0 8px #0ff; }
        .p2 { background: #33ff33; box-shadow: 0 0 8px #0f0; }
        .p3 { background: #ffff33; box-shadow: 0 0 8px #ff0; }

        .container { width: 95%; max-width: 500px; display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .panel { background: var(--panel); padding: 10px; border-radius: 5px; border: 1px solid #333; }
        
        button { 
            background: var(--accent); color: white; border: none; padding: 12px; 
            cursor: pointer; font-weight: bold; width: 100%; border-radius: 4px;
        }
        button:disabled { background: #222; color: #555; }

        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); display: none; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 1000; text-align: center; 
        }
        #scare-img { max-width: 90%; height: auto; border: 3px solid #8b0000; }
        
        .setup-screen { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #000; z-index: 2000; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; text-align: center;
        }
        input { background: #111; color: lime; border: 1px solid #444; padding: 10px; width: 80%; font-size: 12px; }
    </style>
</head>
<body>

    <div id="setup-screen" class="setup-screen">
        <h1 style="color:var(--accent); letter-spacing: 5px;">100 GATES</h1>
        <div id="setup-controls">
            <p>Party Size:</p>
            <select id="max-players-select" style="padding: 10px; width: 150px; background: #222; color: white;">
                <option value="2">2 Players</option>
                <option value="3">3 Players</option>
                <option value="4">4 Players</option>
            </select><br><br>
            <button onclick="initHost()">HOST RITUAL</button>
        </div>
        <div id="waiting-area" style="display:none;">
            <p style="color:red;">INVITE YOUR VICTIMS:</p>
            <input type="text" id="share-url" readonly onclick="this.select()">
            <p id="player-count-display" style="margin-top:20px;">Souls: 1 / ?</p>
        </div>
    </div>

    <div id="status" style="font-size: 14px; margin: 5px; color: yellow;">Connecting...</div>
    <div id="board"></div>

    <div class="container">
        <div class="panel" style="display: flex; align-items: center; justify-content: space-between;">
            <div id="dice-val" style="font-size: 35px;">ðŸŽ²</div>
            <button id="roll-btn" onclick="handleRoll()" style="width: 50%;" disabled>ROLL DICE</button>
            <div id="my-label" style="font-weight: bold; color: #888;">P?</div>
        </div>
    </div>

    <div id="overlay">
        <img id="scare-img" src="">
        <h2 id="event-text" style="color: #ff0000; font-size: 24px;"></h2>
        <button onclick="closeOverlay()" style="width: auto; padding: 15px 40px;">CONTINUE...</button>
    </div>

<script>
    let peer, conn, conns = [];
    let positions = [1, 1, 1, 1];
    let turn = 0;
    let isHost = false;
    let myRole = 0;
    let maxPlayers = 2;

    const GHOST_URL = "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNGI4Njg1NjNiODhjZDJhZjE4NjhiNjM5ZWU5YjVkZGYzZWRjNjA1ZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7TKqnN349PBUtGFO/giphy.gif";

    function createBoard() {
        const board = document.getElementById('board');
        for (let i = 0; i < 100; i++) {
            let row = Math.floor(i / 10);
            let col = i % 10;
            let num = (row % 2 === 0) ? (100 - (row * 10 + col)) : (100 - (row * 10 + (9 - col)));
            let cell = document.createElement('div');
            cell.className = 'cell'; cell.id = 'cell-' + num; cell.innerText = num;
            board.appendChild(cell);
        }
    }

    // Networking
    const hash = window.location.hash.replace('#', '');
    if (hash) {
        isHost = false;
        document.getElementById('setup-controls').innerHTML = "<p>Connecting to Host...</p>";
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(hash);
            setupConnection(conn);
        });
    }

    function initHost() {
        isHost = true;
        maxPlayers = parseInt(document.getElementById('max-players-select').value);
        peer = new Peer();
        peer.on('open', (id) => {
            document.getElementById('setup-controls').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
            document.getElementById('share-url').value = window.location.href + '#' + id;
            document.getElementById('player-count-display').innerText = `Souls: 1 / ${maxPlayers}`;
        });
        peer.on('connection', (c) => {
            conns.push(c);
            document.getElementById('player-count-display').innerText = `Souls: ${conns.length + 1} / ${maxPlayers}`;
            setupConnection(c);
            if (conns.length === maxPlayers - 1) {
                setTimeout(startRitual, 1000);
            }
        });
    }

    function setupConnection(c) {
        c.on('data', (data) => {
            if (data.type === 'init') {
                myRole = data.role;
                maxPlayers = data.max;
                document.getElementById('setup-screen').style.display = 'none';
                updateUI();
            }
            if (data.type === 'game') {
                positions = data.positions;
                turn = data.turn;
                updateUI();
            }
        });
    }

    function startRitual() {
        conns.forEach((c, i) => c.send({type: 'init', role: i+1, max: maxPlayers}));
        document.getElementById('setup-screen').style.display = 'none';
        updateUI();
    }

    function handleRoll() {
        const roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-val').innerText = roll;
        movePlayer(roll);
    }

    function movePlayer(steps) {
        let current = positions[myRole];
        let next = current + steps;

        // Bouncing logic
        if (next > 100) next = 100 - (next - 100);
        if (next < 1) next = 1;

        positions[myRole] = next;
        updateUI();

        if (next === 100) {
            alert("YOU ESCAPED!");
            location.reload();
            return;
        }

        // Surprise Logic (any cell except 1 and 100)
        if (next > 1 && Math.random() > 0.5) {
            setTimeout(triggerSurprise, 600);
        } else {
            finishTurn();
        }
    }

    function triggerSurprise() {
        const surprises = [
            {t: "DARKNESS! Back 7 steps.", m: -7, h: true},
            {t: "GHOST DASH! Forward 10 steps.", m: 10, h: true},
            {t: "CURSED! Back to cell 7.", abs: 7, h: true},
            {t: "TASK: Hold your breath for 5 seconds.", m: 0, h: false}
        ];
        const s = surprises[Math.floor(Math.random() * surprises.length)];
        
        document.getElementById('event-text').innerText = s.t;
        document.getElementById('scare-img').src = s.h ? GHOST_URL : "";
        document.getElementById('overlay').style.display = 'flex';

        if (s.h && navigator.vibrate) navigator.vibrate(500); // Phone Vibrate

        // Apply movement precisely
        if (s.abs) positions[myRole] = s.abs;
        else positions[myRole] = Math.max(1, Math.min(99, positions[myRole] + s.m));
    }

    function finishTurn() {
        turn = (turn + 1) % maxPlayers;
        sync();
        updateUI();
    }

    function sync() {
        const data = {type: 'game', positions, turn};
        if (isHost) conns.forEach(c => c.send(data));
        else {
            // Re-establish or use existing connection to host
            peer.connect(hash).on('open', function() { this.send(data); });
        }
    }

    function updateUI() {
        document.getElementById('status').innerText = (turn === myRole) ? "YOUR TURN" : `PLAYER ${turn+1}'S TURN`;
        document.getElementById('roll-btn').disabled = (turn !== myRole);
        document.getElementById('my-label').innerText = `You: P${myRole+1}`;
        
        document.querySelectorAll('.player').forEach(p => p.remove());
        positions.slice(0, maxPlayers).forEach((pos, i) => {
            const cell = document.getElementById('cell-' + pos);
            const p = document.createElement('div');
            p.className = `player p${i}`;
            p.style.top = (i * 5) + 'px'; p.style.left = (i * 5) + 'px';
            cell.appendChild(p);
        });
    }

    function closeOverlay() {
        document.getElementById('overlay').style.display = 'none';
        finishTurn();
    }

    createBoard();
</script>
</body>
</html>