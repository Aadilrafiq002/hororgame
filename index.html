<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 GATES: FINAL STAND</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #bc0000; --panel: #1a1a1a; }
        body { background: var(--bg); color: #cfcfcf; font-family: 'Courier New', monospace; margin: 0; text-align: center; overflow-x: hidden; touch-action: manipulation; }
        #game-container { display: grid; grid-template-columns: repeat(10, 1fr); width: 95vw; max-width: 400px; aspect-ratio: 1/1; margin: 5px auto; border: 5px solid #333; background: #222; }
        .cell { border: 0.1px solid #222; display: flex; align-items: center; justify-content: center; font-size: 10px; position: relative; background: #121212; }
        .player { width: 18px; height: 18px; border-radius: 50%; position: absolute; border: 2px solid #000; transition: 0.5s; z-index: 10; }
        .p0 { background: #ff3333; } .p1 { background: #33aaff; } .p2 { background: #33ff77; } .p3 { background: #f0ff33; }
        #ritual-log { background: #000; color: #888; padding: 8px; font-size: 12px; height: 35px; border-bottom: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 5000; }
        .event-card { width: 90%; max-width: 350px; text-align: center; }
        #res-img { width: 100%; height: auto; max-height: 350px; object-fit: cover; border: 4px solid var(--accent); border-radius: 5px; margin-bottom: 10px; }
        #chat-window { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 450px; background: #111; z-index: 2000; border-top: 2px solid var(--accent); }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); padding: 10px; gap: 5px; }
        .emoji-grid button { font-size: 24px; padding: 12px; background: #222; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .panel { background: var(--panel); padding: 10px; border-radius: 10px; width: 90%; max-width: 400px; border: 1px solid var(--accent); margin: 5px auto; }
        #roll-btn { padding: 15px; width: 100%; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; border: none; }
        .btn-active { background: #008000; color: white; box-shadow: 0 0 15px #00ff00; }
        .btn-wait { background: #333; color: #666; }
        .btn-finished { background: #111; color: gold; border: 1px solid gold; cursor: default; }
        #finish-screen { position: fixed; inset: 0; background: #000; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        #emoji-flash { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9000; pointer-events: none; }
    </style>
</head>
<body>

    <div id="finish-screen">
        <img id="finish-img" style="width:80%; max-width:300px; border:3px solid gold;">
        <h1 id="finish-title" style="font-size:35px; margin:10px 0;"></h1>
        <p id="finish-joke" style="font-size:18px; padding:0 20px; font-style: italic;"></p>
        <div id="finish-btn-area"></div>
    </div>

    <div id="emoji-flash"><p id="flash-content" style="font-size:120px; margin:0;"></p><p id="flash-user" style="color:red; font-size:20px;"></p></div>

    <div id="setup-screen" style="position:fixed; inset:0; background:#000; z-index:8000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 style="color:var(--accent); font-size:40px;">100 GATES</h1>
        <div id="ui-box" class="panel"><button onclick="unlockAudio()" style="width:100%; padding:20px; font-weight:bold; cursor:pointer;">START RITUAL</button></div>
    </div>

    <div id="ritual-log">Waiting for players...</div>
    <div id="inv-display" style="color:gold; font-weight:bold; font-size:18px; margin-top:5px;">CARDS: 0</div>
    <div id="game-container"></div>

    <div class="panel" style="margin-bottom: 120px;">
        <div id="dice-box" style="font-size: 24px; margin-bottom: 5px;">üé≤</div>
        <button id="roll-btn" class="btn-wait" onclick="playTurn()" disabled>WAITING...</button>
    </div>

    <div id="chat-window">
        <div class="emoji-grid">
            <button onclick="sendEmoji('üëª')">üëª</button><button onclick="sendEmoji('üíÄ')">üíÄ</button>
            <button onclick="sendEmoji('üò±')">üò±</button><button onclick="sendEmoji('üî•')">üî•</button>
            <button onclick="sendEmoji('üòà')">üòà</button><button onclick="sendEmoji('üòÇ')">üòÇ</button>
            <button onclick="sendEmoji('üôè')">üôè</button><button onclick="sendEmoji('ü§´')">ü§´</button>
            <button onclick="sendEmoji('üëé')">üëé</button><button onclick="sendEmoji('ü§°')">ü§°</button>
        </div>
    </div>

    <div id="overlay">
        <div class="event-card">
            <img id="res-img" src="" alt="">
            <h2 id="res-text" style="color:white; margin:10px 0; text-shadow:2px 2px #000;"></h2>
            <div id="event-actions"></div>
        </div>
    </div>

<script>
    let peer, hostConn, guestConns = [];
    let myRole = -1, isHost = false, turn = 0, positions = [1,1,1,1], maxPlayers = 2;
    let personalRolls = 0, inventory = { passes: 0 }, finished = [false, false, false, false];

    const sounds = { dice: new Audio('dice.mp3'), jump: new Audio('jump.mp3'), noob: new Audio('noob.mp3') };
    function playSound(n) { const s = sounds[n].cloneNode(); s.play().catch(()=>{}); }

    const winJokes = ["You outran the ghosts! Now go outside, the sun won't bite.", "Winner! You are officially too fast for this haunted house.", "Congrats! The spirits gave up because you're too boring to haunt."];
    const loseJokes = ["Gate 100 has been reached. You're basically a turtle in a haunted shell.", "Finish the game or the ghosts will start charging you rent!", "Hurry up! Even the skeletons are tired of waiting for you."];

    function unlockAudio() {
        playSound('dice');
        const rID = window.location.hash.substring(1);
        if (rID) startAsGuest(rID); else showHostUI();
    }

    function showHostUI() {
        document.getElementById('ui-box').innerHTML = `
            <select id="p-count" style="width:100%; padding:15px; background:#000; color:white;">
                <option value="2">2 Players</option><option value="3">3 Players</option><option value="4">4 Players</option>
            </select>
            <button onclick="startAsHost()" style="background:red; color:white; width:100%; margin-top:15px; padding:15px; border:none; font-weight:bold; cursor:pointer;">HOST</button>`;
    }

    function startAsHost() {
        isHost = true; maxPlayers = parseInt(document.getElementById('p-count').value);
        peer = new Peer();
        peer.on('open', (id) => { 
            myRole = 0; const link = window.location.origin + window.location.pathname + '#' + id;
            document.getElementById('ui-box').innerHTML = `<p style="font-size:12px">SHARE LINK:</p><input type="text" value="${link}" id="lInp" readonly style="width:100%; padding:8px;"><button onclick="copyL()" style="width:100%; margin-top:10px; padding:10px;">COPY LINK</button>`;
        });
        peer.on('connection', (c) => { 
            guestConns.push(c); 
            c.on('data', d => handleData(d)); 
            if(guestConns.length === maxPlayers-1) setTimeout(sendInit, 1000); 
        });
    }

    function startAsGuest(id) { 
        peer = new Peer(); 
        peer.on('open', () => { hostConn = peer.connect(id); hostConn.on('data', d => handleData(d)); }); 
    }

    function playTurn() {
        if(finished[myRole]) return;
        playSound('dice');
        let roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-box').innerText = "üé≤ " + roll;
        positions[myRole] += roll;
        personalRolls++;

        if (positions[myRole] >= 100) { 
            positions[myRole] = 100;
            finished[myRole] = true;
            updateUI();
            const d = { type: 'finish', winner: myRole, msg: `P${myRole+1} HAS FINISHED!` };
            if (isHost) broadcast(d); else hostConn.send(d);
            showFinishScreen(true, myRole);
            return; 
        }
        
        if (personalRolls >= 2 || Math.random() < 0.25) {
            personalRolls = 0;
            triggerResult(roll);
        } else {
            sync(`P${myRole+1} rolled ${roll}`);
        }
    }

    function showFinishScreen(isMe, idx) {
        const screen = document.getElementById('finish-screen');
        const btnArea = document.getElementById('finish-btn-area');
        screen.style.display = "flex";
        
        let activeCount = finished.slice(0, maxPlayers).filter(f => !f).length;

        if(isMe) {
            document.getElementById('finish-img').src = "f1.jpg";
            document.getElementById('finish-title').innerText = "üéâ CONGRATULATIONS!";
            document.getElementById('finish-joke').innerText = winJokes[Math.floor(Math.random()*winJokes.length)];
        } else {
            playSound('noob');
            document.getElementById('finish-img').src = "h1.jpg";
            document.getElementById('finish-title').innerText = `P${idx+1} FINISHED!`;
            document.getElementById('finish-joke').innerText = loseJokes[Math.floor(Math.random()*loseJokes.length)];
        }

        if(activeCount > 1) {
            btnArea.innerHTML = `<button onclick="document.getElementById('finish-screen').style.display='none'" style="margin-top:20px; padding:15px 30px; font-weight:bold;">WATCH OTHERS</button>`;
        } else {
            btnArea.innerHTML = `<button onclick="location.reload()" style="margin-top:20px; padding:15px 30px; font-weight:bold; background:gold;">NEW GAME</button>`;
        }
    }

    function triggerResult(roll) {
        const overlay = document.getElementById('overlay');
        const actions = document.getElementById('event-actions');
        overlay.style.display = "flex";
        let isTrap = Math.random() > 0.45;
        let randNum = Math.floor(Math.random() * 5) + 1;
        let type = isTrap ? 'h' : 'f';
        document.getElementById('res-img').src = type + randNum + ".jpg";

        if (!isTrap) {
            inventory.passes++;
            document.getElementById('res-text').innerText = "LOOT: Sabotage Card!";
            actions.innerHTML = `<button onclick="closeOverlaySync('P${myRole+1} got a card')" style="width:100%; padding:15px; font-weight:bold;">COLLECT & END TURN</button>`;
        } else {
            playSound('jump');
            document.getElementById('res-text').innerText = "TRAP: -10 STEPS!";
            let passButtons = "";
            if (inventory.passes > 0) {
                for (let i=0; i<maxPlayers; i++) {
                    if(i !== myRole && !finished[i]) {
                        passButtons += `<button onclick="usePass(${i})" style="background:purple; color:white; margin-top:5px; padding:12px; width:100%; border:none; border-radius:5px; font-weight:bold;">PASS TO P${i+1} & END TURN</button>`;
                    }
                }
            }
            actions.innerHTML = `<button onclick="takePunishment()" style="width:100%; padding:15px; font-weight:bold;">ACCEPT & END TURN</button>${passButtons}`;
        }
        updateUI();
    }

    function usePass(target) {
        inventory.passes--;
        document.getElementById('overlay').style.display = "none";
        // Sabotage sends data AND moves the turn forward
        const d = { type: 'sabotage', to: target, from: myRole, msg: `P${myRole+1} SABOTAGED P${target+1}!` };
        if (isHost) broadcast(d); else hostConn.send(d);
        sync(`P${myRole+1} used a card on P${target+1}`); // This ends the turn
    }

    function handleData(d) {
        if (isHost) { guestConns.forEach(c => { if(c.peer !== d.fromPeer) c.send(d); }); }
        if (d.type === 'chat') {
            const f = document.getElementById('emoji-flash');
            document.getElementById('flash-content').innerText = d.text;
            document.getElementById('flash-user').innerText = d.sender;
            f.style.display = "flex";
            if(d.text === 'ü§°') playSound('noob');
            setTimeout(() => f.style.display = "none", 1500);
        }
        if (d.type === 'init') { myRole = d.role; maxPlayers = d.max; positions = d.pos; turn = d.turn; finished = d.fin; document.getElementById('setup-screen').style.display = 'none'; updateUI(); }
        if (d.type === 'sync') { positions = d.pos; turn = d.turn; document.getElementById('ritual-log').innerText = d.msg; updateUI(); }
        if (d.type === 'finish') { 
            finished[d.winner] = true; positions[d.winner] = 100;
            document.getElementById('ritual-log').innerText = d.msg;
            showFinishScreen(false, d.winner);
            updateUI();
        }
        if (d.type === 'sabotage') { positions[d.to] = Math.max(1, positions[d.to]-10); if(d.to === myRole) playSound('noob'); updateUI(); }
    }

    function broadcast(d) { handleData(d); guestConns.forEach(c => c.send(d)); }

    function sync(msg) {
        nextTurn();
        const d = { type: 'sync', pos: positions, turn: turn, msg: msg, fin: finished };
        if (isHost) broadcast(d); else hostConn.send(d);
        updateUI();
    }

    function nextTurn() {
        let activePlayers = finished.slice(0, maxPlayers).filter(f => !f).length;
        if(activePlayers <= 0) return; 

        let safety = 0;
        do {
            turn = (turn + 1) % maxPlayers;
            safety++;
        } while (finished[turn] && safety < 10);
    }

    function updateUI() {
        const active = (turn === myRole && !finished[myRole]);
        const btn = document.getElementById('roll-btn');
        if(finished[myRole]) {
            btn.disabled = true; btn.innerText = "üèÜ FINISHED"; btn.className = "btn-finished";
        } else {
            btn.disabled = !active;
            btn.innerText = active ? "ROLL DICE" : `P${turn+1}'S TURN`;
            btn.className = active ? "btn-active" : "btn-wait";
        }
        document.getElementById('inv-display').innerText = `CARDS: ${inventory.passes}`;
        document.querySelectorAll('.player').forEach(p => p.remove());
        positions.slice(0, maxPlayers).forEach((pos, i) => {
            const cell = document.getElementById('cell-' + pos);
            if (cell) {
                const dot = document.createElement('div');
                dot.className = `player p${i}`;
                cell.appendChild(dot);
            }
        });
    }

    function takePunishment() { positions[myRole] = Math.max(1, positions[myRole]-10); document.getElementById('overlay').style.display = "none"; playSound('noob'); sync(`P${myRole+1} hit a trap!`); }
    function sendEmoji(e) { const m = { type: 'chat', sender: `P${myRole+1}`, text: e }; if (isHost) broadcast(m); else hostConn.send(m); }
    function closeOverlaySync(m) { document.getElementById('overlay').style.display="none"; sync(m); }
    function copyL() { const i = document.getElementById('lInp'); i.select(); navigator.clipboard.writeText(i.value); alert("Link Copied!"); }
    function sendInit() { guestConns.forEach((c, i) => c.send({ type: 'init', role: i+1, max: maxPlayers, pos: positions, turn: turn, fin: finished })); document.getElementById('setup-screen').style.display = 'none'; updateUI(); }

    const board = document.getElementById('game-container');
    for (let i = 0; i < 100; i++) {
        let row = Math.floor(i / 10), col = i % 10, num;
        if (row % 2 === 0) num = 100 - (row * 10 + col);
        else num = 100 - (row * 10 + (9 - col));
        let cell = document.createElement('div');
        cell.className = 'cell'; cell.id = 'cell-' + num; cell.innerText = num;
        board.appendChild(cell);
    }
</script>
</body>
</html>
