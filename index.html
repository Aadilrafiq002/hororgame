<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 GATES: INFERNAL EDITION</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #bc0000; --panel: #1a1a1a; --fire: #ff4500; }
        body { background: var(--bg); color: #cfcfcf; font-family: 'Courier New', monospace; margin: 0; text-align: center; overflow-x: hidden; touch-action: manipulation; }
        #conn-status { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: #555; z-index: 10000; }
        #conn-status.online { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
        #conn-status.offline { background: #ff0000; }
        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #auth-screen input { padding: 12px; margin: 5px; width: 80%; max-width: 300px; background: #111; border: 1px solid #444; color: white; border-radius: 5px; }
        #soul-bar { display: flex; justify-content: center; gap: 10px; background: #111; padding: 8px; border-bottom: 1px solid #333; font-size: 11px; flex-wrap: wrap; }
        .soul-id { display: flex; align-items: center; gap: 5px; padding: 2px 8px; border-radius: 15px; background: #1a1a1a; border: 1px solid #333; }
        .soul-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .my-identity { border-color: var(--accent); background: #2a0000; }
        .active-turn { box-shadow: 0 0 10px gold; border-color: gold; color: gold; }
        #game-container { display: grid; grid-template-columns: repeat(10, 1fr); width: 95vw; max-width: 400px; aspect-ratio: 1/1; margin: 5px auto; border: 5px solid #333; background: #000; }
        .cell { border: 0.1px solid #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 10px; position: relative; background: #080808; color: #444; overflow: hidden; }
        .fire-glow { position: absolute; inset: 0; opacity: 0; background: radial-gradient(circle, rgba(255,69,0,0.3) 0%, transparent 70%); }
        .player { width: 16px; height: 16px; border-radius: 50%; position: absolute; border: 2px solid #000; z-index: 10; transition: all 0.2s linear; }
        .p0 { background: #ff3333; box-shadow: 0 0 10px #f00; } 
        .p1 { background: #33aaff; box-shadow: 0 0 10px #0af; } 
        .p2 { background: #33ff77; box-shadow: 0 0 10px #0f7; } 
        .p3 { background: #f0ff33; box-shadow: 0 0 10px #ff0; }
        #ritual-log { background: #000; color: #888; padding: 5px; font-size: 12px; height: 25px; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid #222;}
        .panel { background: var(--panel); padding: 8px; border-radius: 10px; width: 90%; max-width: 400px; border: 1px solid var(--accent); margin: 5px auto; }
        #roll-btn { padding: 12px; width: 100%; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; border: none; }
        .btn-active { background: #008000; color: white; }
        .btn-wait { background: #222; color: #555; }
        #chat-window { position: fixed; bottom: 0; left: 0; right: 0; background: #111; z-index: 8000; border-top: 2px solid var(--accent); padding-bottom: env(safe-area-inset-bottom); }
        .emoji-grid { display: grid; grid-template-columns: repeat(5, 1fr); max-width: 400px; margin: 0 auto; padding: 6px; gap: 5px; }
        .emoji-grid button { font-size: 22px; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 8px; cursor: pointer; }
        #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9000; padding: 20px; }
        #emoji-flash { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9500; pointer-events: none; }
        .menu-btn { width: 80%; padding: 15px; margin: 5px; border: none; font-weight: bold; cursor: pointer; border-radius: 5px; color: white; }
    </style>
</head>
<body>

    <div id="conn-status"></div>
    <audio id="bg-music" loop><source src="bg.mp3" type="audio/mpeg"></audio>

    <div id="auth-screen">
        <h1 style="color:var(--accent); font-size: 40px; letter-spacing: 5px;">100 GATES</h1>
        <div id="auth-inputs">
            <input type="text" id="user-name" placeholder="Name">
            <input type="password" id="admin-pass" placeholder="Admin Key">
            <button onclick="handleAuth()" class="menu-btn" style="background:var(--accent);">ENTER THE VOID</button>
        </div>
        <div id="mode-selection" style="display:none; width: 100%; flex-direction: column; align-items: center;">
            <button onclick="startVsCPU()" class="menu-btn" style="background:#444;">PLAY WITH COMPUTER</button>
            <button onclick="showLobbySettings()" class="menu-btn" style="background:var(--accent);">PLAY WITH FRIENDS</button>
        </div>
    </div>

    <div id="soul-bar"></div>
    <div id="emoji-flash"><p id="flash-content" style="font-size: 80px;"></p><p id="flash-user" style="color:red; font-size: 20px;"></p></div>

    <div id="setup-screen" style="position:fixed; inset:0; background:#000; z-index:8500; display:none; flex-direction:column; justify-content:center; align-items:center;">
        <div id="ui-box" class="panel"></div>
    </div>

    <div id="ritual-log">Summoning spirits...</div>
    <div id="game-container"></div>

    <div class="panel" style="margin-bottom: 130px;">
        <div id="dice-box" style="font-size: 20px; margin-bottom: 5px;">üé≤</div>
        <button id="roll-btn" class="btn-wait" onclick="humanPlayerTurn()" disabled>WAITING...</button>
        <div id="inv-display" style="color:gold; font-size: 12px; font-weight:bold; margin-top:5px;">CARDS: 0 (0/5 USED)</div>
        <div id="host-controls" style="margin-top: 10px;"></div>
    </div>

    <div id="chat-window">
        <div class="emoji-grid">
            <button onclick="sendEmoji('üëª')">üëª</button><button onclick="sendEmoji('üíÄ')">üíÄ</button>
            <button onclick="sendEmoji('üò±')">üò±</button><button onclick="sendEmoji('üî•')">üî•</button>
            <button onclick="sendEmoji('üòà')">üòà</button><button onclick="sendEmoji('üòÇ')">üòÇ</button>
            <button onclick="sendEmoji('üôè')">üôè</button><button onclick="sendEmoji('ü§´')">ü§´</button>
            <button onclick="sendEmoji('üëé')">üëé</button><button onclick="sendEmoji('ü§°')">ü§°</button>
        </div>
    </div>

    <div id="overlay"><div class="panel" style="text-align:center;"><img id="res-img" src="" style="width:100%; max-height:30vh; object-fit:contain;"><h2 id="res-text"></h2><div id="event-actions"></div></div></div>

<script>
    // --- GLOBAL CONFIG ---
    const ADMIN_USER = "aadil";
    const ADMIN_PASS = "aadil123";
    let peer, hostConn, guestConns = [];
    let myRole = -1, isHost = false, turn = 0, positions = [1,1,1,1], maxPlayers = 2;
    let personalRolls = 0, inventory = { passes: 0, usedCount: 0 }, finished = [false, false, false, false];
    let playerNames = ["P1", "P2", "P3", "P4"];
    let isMoving = false;
    let isVsCPU = false;

    const sounds = { dice: new Audio('dice.mp3'), jump: new Audio('jump.mp3'), noob: new Audio('noob.mp3') };
    function playSound(n) { const s = sounds[n]?.cloneNode(); s?.play().catch(()=>{}); }

    // --- BOARD GENERATION ---
    const boardEl = document.getElementById('game-container');
    const cells = [];
    for (let i = 0; i < 100; i++) {
        let row = Math.floor(i / 10), col = i % 10, num;
        if (row % 2 === 0) num = 100 - (row * 10 + col); else num = 100 - (row * 10 + (9 - col));
        let cell = document.createElement('div'); cell.className = 'cell'; cell.id = 'cell-' + num; cell.innerText = num;
        let glow = document.createElement('div'); glow.className = 'fire-glow'; cell.appendChild(glow);
        boardEl.appendChild(cell);
        cells.push(glow);
    }
    function flickerFire() {
        cells.forEach(c => { if (Math.random() < 0.05) { c.style.opacity = Math.random() * 0.8; setTimeout(() => { c.style.opacity = 0; }, 200 + Math.random() * 800); } });
        requestAnimationFrame(flickerFire);
    }
    flickerFire();

    // --- AUTH & MODE SELECTION ---
    function handleAuth() {
        const name = document.getElementById('user-name').value.trim();
        const pass = document.getElementById('admin-pass').value.trim();
        const rID = window.location.hash.substring(1);
        if(!name) return;
        localStorage.setItem('gate_username', name);
        if (name.toLowerCase() === ADMIN_USER && pass === ADMIN_PASS) {
            document.getElementById('auth-inputs').style.display = 'none';
            document.getElementById('mode-selection').style.display = 'flex';
        } else if (rID) {
            isHost = false; document.getElementById('auth-screen').style.display = 'none'; startAsGuest(rID, name); 
        } else { alert("Admins Only or Join via Link!"); }
    }

    function startVsCPU() {
        isVsCPU = true; isHost = true; myRole = 0; maxPlayers = 2;
        playerNames[0] = localStorage.getItem('gate_username');
        playerNames[1] = "HELL_BOT";
        document.getElementById('auth-screen').style.display = 'none';
        updateUI();
    }

    function showLobbySettings() { isVsCPU = false; document.getElementById('auth-screen').style.display = 'none'; showHostUI(); }

    // --- SECTION 1: HUMAN PLAYER LOGIC (With Images & Overlays) ---
    async function humanPlayerTurn() {
        if(finished[myRole] || isMoving) return;
        isMoving = true;
        playSound('dice');
        let roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-box').innerText = "üé≤ " + roll;
        let target = Math.min(100, positions[myRole] + roll);
        
        await animateMove(myRole, target);
        personalRolls++;

        if (positions[myRole] >= 100) { 
            finished[myRole] = true;
            isMoving = false;
            if(!isVsCPU) broadcast({ type: 'finish', winner: myRole });
            handleJudgment(myRole);
            return; 
        }

        // Trigger Event for Human (Show Image)
        if (personalRolls >= 2 || Math.random() < 0.35) {
            personalRolls = 0;
            triggerHumanOverlay(); 
        } else {
            isMoving = false;
            syncTurnState(`${playerNames[myRole]} moved to gate ${positions[myRole]}`);
        }
    }

    function triggerHumanOverlay() {
        const overlay = document.getElementById('overlay');
        const text = document.getElementById('res-text');
        const actions = document.getElementById('event-actions');
        const img = document.getElementById('res-img');
        overlay.style.display = "flex";
        
        let r = Math.random() * 100;
        if (r < 15) {
            img.src = "https://img.icons8.com/emoji/96/000000/cyclone-emoji.png";
            text.innerHTML = "THE VOID<br><small>Banished back to gate 1.</small>";
            actions.innerHTML = `<button onclick="applyHumanPenalty(99)" style="background:purple; color:white; padding:10px; width:100%; border:none;">ACCEPT FATE</button>`;
        } else if (r < 45) {
            inventory.passes++;
            img.src = "https://img.icons8.com/emoji/96/000000/joker.png";
            text.innerHTML = "SABOTAGE CARD<br><small>Use your inventory to drag others back!</small>";
            let targetBtns = "";
            playerNames.slice(0, maxPlayers).forEach((name, i) => {
                if (i !== myRole && !finished[i]) {
                    targetBtns += `<button onclick="useHumanSabotage(${i})" style="background:red; color:white; padding:8px; margin:5px;">SABOTAGE ${name}</button>`;
                }
            });
            actions.innerHTML = targetBtns + `<button onclick="closeHumanOverlay('Card Collected')" style="background:#444; color:white; padding:8px; width:100%; margin-top:5px;">SAVE FOR LATER</button>`;
        } else if (r < 75) {
            img.src = "https://img.icons8.com/emoji/96/000000/fire.png";
            text.innerHTML = "INFERNAL TRAP<br><small>Burned back 10 gates.</small>";
            actions.innerHTML = `<button onclick="applyHumanPenalty(10)" style="background:orange; color:white; padding:10px; width:100%; border:none;">IT BURNS!</button>`;
        } else {
            img.src = "https://img.icons8.com/emoji/96/000000/sparkles.png";
            text.innerHTML = "DEMONIC LUCK<br><small>Advance 8 gates.</small>";
            actions.innerHTML = `<button onclick="applyHumanReward(8)" style="background:green; color:white; padding:10px; width:100%; border:none;">THANK YOU</button>`;
        }
    }

    async function useHumanSabotage(targetIdx) {
        if(inventory.passes <= 0) return;
        inventory.passes--;
        inventory.usedCount++;
        document.getElementById('overlay').style.display = "none";
        
        let newPos = Math.max(1, positions[targetIdx] - 12);
        if(isVsCPU) {
            await animateMove(targetIdx, newPos);
            isMoving = false;
            syncTurnState(`SABOTAGED ${playerNames[targetIdx]}!`);
        } else {
            broadcast({ type: 'sabotage', to: targetIdx, newPos: newPos });
            isMoving = false;
            syncTurnState(`SABOTAGED ${playerNames[targetIdx]}!`);
        }
    }

    async function applyHumanPenalty(amt) { 
        document.getElementById('overlay').style.display = "none"; 
        let targetPos = Math.max(1, positions[myRole] - amt);
        await animateMove(myRole, targetPos); 
        isMoving = false; 
        syncTurnState(`Human fell into a trap!`); 
    }

    async function applyHumanReward(amt) { 
        document.getElementById('overlay').style.display = "none"; 
        let targetPos = Math.min(100, positions[myRole] + amt);
        await animateMove(myRole, targetPos); 
        isMoving = false; 
        syncTurnState(`Human was blessed!`); 
    }

    function closeHumanOverlay(msg) { document.getElementById('overlay').style.display="none"; isMoving = false; syncTurnState(msg); }

    // --- SECTION 2: COMPUTER/BOT LOGIC (Background calculations, no overlays) ---
    async function botPlayerTurn() {
        if (finished[1] || isMoving || turn !== 1) return;
        isMoving = true;
        document.getElementById('ritual-log').innerText = "HELL_BOT is thinking...";
        await new Promise(r => setTimeout(r, 1500));
        
        let roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-box').innerText = "üé≤ " + roll;
        playSound('dice');
        
        let target = Math.min(100, positions[1] + roll);
        await animateMove(1, target);

        if (positions[1] >= 100) {
            finished[1] = true;
            isMoving = false;
            handleJudgment(1);
            return;
        }

        // Bot processes event instantly (Logic only, no image)
        calculateBotEvent();
    }

    async function calculateBotEvent() {
        let r = Math.random() * 100;
        let botMsg = "Bot moved safely.";
        
        if (r < 15) {
            positions[1] = Math.max(1, positions[1] - 12);
            botMsg = "BOT hit an Infernal Trap!";
        } else if (r < 30) {
            positions[1] = Math.min(100, positions[1] + 6);
            botMsg = "BOT received Demonic Luck!";
        } else if (r < 40) {
            // Bot uses sabotage if it has "imaginary" cards
            positions[0] = Math.max(1, positions[0] - 5);
            botMsg = "BOT used a Sabotage Shard on you!";
        }
        
        refreshBoardDots();
        await new Promise(r => setTimeout(r, 800));
        isMoving = false;
        syncTurnState(botMsg);
    }

    // --- SHARED CORE UTILITIES ---
    async function animateMove(pIdx, target) {
        let cur = positions[pIdx];
        const step = target > cur ? 1 : -1;
        while (cur !== target) {
            cur += step;
            positions[pIdx] = cur;
            refreshBoardDots();
            await new Promise(r => setTimeout(r, 120)); 
        }
    }

    function refreshBoardDots() {
        document.querySelectorAll('.player').forEach(p => p.remove());
        positions.slice(0, maxPlayers).forEach((pos, i) => {
            const cell = document.getElementById('cell-' + pos);
            if (cell) {
                const dot = document.createElement('div');
                dot.className = `player p${i}`;
                cell.appendChild(dot);
            }
        });
    }

    function syncTurnState(msg) { 
        // Logic to pass turn
        let activeRem = finished.slice(0, maxPlayers).filter(f => !f).length;
        if(activeRem > 1) {
            do { turn = (turn + 1) % maxPlayers; } while (finished[turn]); 
        }

        if(!isVsCPU) {
            const data = { type: 'sync', pos: positions, turn: turn, msg: msg, fin: finished }; 
            if (isHost) broadcast(data); else hostConn.send(data); 
        } else {
            document.getElementById('ritual-log').innerText = msg;
        }
        updateUI(); 
    }

    function updateUI() {
        const isMyTurn = (turn === myRole && !finished[myRole] && !isMoving);
        const btn = document.getElementById('roll-btn');
        btn.disabled = !isMyTurn;
        btn.innerText = isMyTurn ? "ROLL DICE" : (isMoving ? "MOVING..." : playerNames[turn] + "'S TURN");
        btn.className = isMyTurn ? "btn-active" : "btn-wait";
        
        document.getElementById('inv-display').innerText = `CARDS: ${inventory.passes} (${inventory.usedCount}/5 USED)`;
        
        const sBar = document.getElementById('soul-bar'); sBar.innerHTML = "";
        playerNames.slice(0, maxPlayers).forEach((name, i) => {
            const div = document.createElement('div');
            div.className = `soul-id ${i === myRole ? 'my-identity' : ''} ${i === turn ? 'active-turn' : ''}`;
            div.innerHTML = `<span class="soul-dot p${i}"></span> ${finished[i] ? 'üèÅ ' : ''}${name}`;
            sBar.appendChild(div);
        });

        refreshBoardDots();
        // Auto-trigger Bot if VS CPU mode
        if (isVsCPU && turn === 1 && !finished[1] && !isMoving) botPlayerTurn();
    }

    function handleJudgment(winnerIdx) {
        const overlay = document.getElementById('overlay');
        overlay.style.display = "flex";
        const isWinner = (myRole === winnerIdx);
        document.getElementById('res-img').src = isWinner ? "https://img.icons8.com/emoji/96/000000/trophy-emoji.png" : "https://img.icons8.com/emoji/96/000000/skull-emoji.png";
        document.getElementById('res-text').innerHTML = isWinner ? "üèÜ ESCAPED! üèÜ" : "üíÄ DEFEATED! üíÄ<br><small>The Bot outsmarted you.</small>";
        document.getElementById('event-actions').innerHTML = `<button onclick="location.reload()" style="padding:10px; background:red; color:white; border:none; width:100%;">BACK TO MENU</button>`;
    }

    // --- SECTION 3: MULTIPLAYER FRIENDS LOGIC (Networking) ---
    function showHostUI() {
        document.getElementById('setup-screen').style.display = 'flex';
        document.getElementById('ui-box').innerHTML = `<p style="color:red; font-weight:bold;">GATE KEEPER</p><select id="p-count" style="width:100%; padding:15px; background:#000; color:white;"><option value="2">2 Players</option><option value="3">3 Players</option><option value="4">4 Players</option></select><button onclick="startAsHost()" style="background:red; color:white; width:100%; margin-top:15px; padding:15px; border:none; font-weight:bold;">ACTIVATE GATE</button>`;
    }
    function startAsHost() {
        maxPlayers = parseInt(document.getElementById('p-count').value);
        playerNames[0] = localStorage.getItem('gate_username');
        myRole = 0; initPeer();
    }
    function initPeer(id = null) {
        if (peer) peer.destroy();
        peer = id ? new Peer(id) : new Peer();
        peer.on('open', (newId) => {
            document.getElementById('conn-status').className = 'online';
            if (isHost) updateHostUI(window.location.origin + window.location.pathname + '#' + newId);
        });
        if (isHost) setupNetworkListeners();
    }
    function setupNetworkListeners() {
        peer.on('connection', c => {
            c.on('data', d => {
                if(d.type === 'join_request') {
                    if (guestConns.length < maxPlayers - 1) { 
                        guestConns.push(c); 
                        playerNames[guestConns.length] = d.name; 
                        if(guestConns.length === maxPlayers-1) sendInitToAll(); 
                    }
                }
                handleNetworkData(d);
            });
        });
    }
    function startAsGuest(id, myName) { 
        peer = new Peer(); 
        peer.on('open', () => { 
            document.getElementById('conn-status').className = 'online';
            hostConn = peer.connect(id, {reliable: true}); 
            hostConn.on('open', () => { hostConn.send({ type: 'join_request', name: myName }); });
            hostConn.on('data', d => handleNetworkData(d)); 
        }); 
    }
    async function handleNetworkData(d) {
        if (isHost) guestConns.forEach(c => { if(c && c.peer !== d.fromPeer) c.send(d); });
        if (d.type === 'sabotage') { await animateMove(d.to, d.newPos); updateUI(); }
        if (d.type === 'sync') { if(!isMoving) positions = d.pos; turn = d.turn; document.getElementById('ritual-log').innerText = d.msg; updateUI(); }
        if (d.type === 'init') { myRole = d.role; maxPlayers = d.max; positions = d.pos; turn = d.turn; finished = d.fin; playerNames = d.names; document.getElementById('setup-screen').style.display = 'none'; updateUI(); }
        if (d.type === 'finish') { finished[d.winner] = true; updateUI(); handleJudgment(d.winner); }
    }
    function broadcast(d) { handleNetworkData(d); guestConns.forEach(c => { if(c) c.send(d); }); }
    function sendInitToAll() { guestConns.forEach((c, i) => { if(c) c.send({ type: 'init', role: i+1, max: maxPlayers, pos: positions, turn: turn, fin: finished, names: playerNames }) }); document.getElementById('setup-screen').style.display = 'none'; updateUI(); }
    function updateHostUI(link) { document.getElementById('ui-box').innerHTML = `<p>SHARE LINK:</p><input type="text" value="${link}" id="lInp" readonly style="width:100%; padding:8px; background:#000; color:white;"><button onclick="copyLink()">COPY LINK</button><button onclick="sendInitToAll()" style="background:green; color:white; width:100%; margin-top:15px; padding:10px; border:none;">FORCE START</button>`; }
    function copyLink() { const i = document.getElementById('lInp'); i.select(); navigator.clipboard.writeText(i.value); alert("Link Copied!"); }
</script>
</body>
</html>
