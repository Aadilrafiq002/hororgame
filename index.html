<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 Gates of Horror</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #8b0000; --panel: #1a1a1a; }
        
        * { box-sizing: border-box; }
        body { 
            background: var(--bg); color: #ddd; font-family: 'Courier New', monospace; 
            margin: 0; padding: 5px; display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; touch-action: manipulation;
        }

        /* Responsive Board Container */
        #game-wrapper {
            width: 98vw;
            max-width: 500px;
            aspect-ratio: 1 / 1;
            border: 4px solid #333;
            display: flex;
            flex-wrap: wrap-reverse; /* Builds from 1 at bottom to 100 at top */
            background: #222;
        }

        .cell { 
            width: 10%; height: 10%; 
            background: #111; border: 1px solid #222;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; position: relative; color: #555;
        }

        .player { 
            width: 14px; height: 14px; border-radius: 50%; position: absolute; 
            z-index: 10; border: 1px solid #fff; transition: all 0.4s ease; 
        }
        .p0 { background: #ff3333; box-shadow: 0 0 8px #f00; }
        .p1 { background: #33ffff; box-shadow: 0 0 8px #0ff; }
        .p2 { background: #33ff33; box-shadow: 0 0 8px #0f0; }
        .p3 { background: #ffff33; box-shadow: 0 0 8px #ff0; }

        .container { width: 95%; max-width: 500px; margin-top: 10px; }
        .panel { background: var(--panel); padding: 15px; border-radius: 5px; text-align: center; }
        
        button { 
            background: var(--accent); color: white; border: none; padding: 15px; 
            cursor: pointer; font-weight: bold; width: 100%; border-radius: 5px; font-size: 18px;
        }
        button:disabled { background: #222; color: #444; }

        #overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; display: none; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 1000; 
        }
        #scare-img { max-width: 80%; height: auto; border: 2px solid red; margin-bottom: 20px;}

        .setup-screen { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #000; z-index: 2000; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; padding: 20px;
        }
    </style>
</head>
<body>

    <div id="setup-screen" class="setup-screen">
        <h1 style="color:var(--accent)">100 GATES</h1>
        <div id="setup-controls">
            <select id="max-players-select" style="padding: 10px; font-size: 16px;">
                <option value="2">2 Players</option>
                <option value="3">3 Players</option>
                <option value="4">4 Players</option>
            </select><br><br>
            <button onclick="initHost()">HOST RITUAL</button>
        </div>
        <div id="waiting-area" style="display:none; text-align: center;">
            <p>SHARE LINK TO FRIENDS:</p>
            <input type="text" id="share-url" style="width:100%; padding:10px;" readonly>
            <p id="player-count-display" style="color:red; font-weight:bold;"></p>
        </div>
    </div>

    <div id="status" style="color: yellow; margin: 5px;">Waiting...</div>
    <div id="game-wrapper"></div>

    <div class="container">
        <div class="panel">
            <div id="dice-val" style="font-size: 40px; margin-bottom: 10px;">ðŸŽ²</div>
            <button id="roll-btn" onclick="handleRoll()" disabled>ROLL DICE</button>
            <p id="my-id-display" style="font-size: 12px; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="overlay">
        <img id="scare-img" src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNGI4Njg1NjNiODhjZDJhZjE4NjhiNjM5ZWU5YjVkZGYzZWRjNjA1ZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/3o7TKqnN349PBUtGFO/giphy.gif">
        <h2 id="event-text" style="color: red; text-align: center;"></h2>
        <button onclick="closeOverlay()" style="width: auto;">I ACCEPT</button>
    </div>

<script>
    let peer, conns = [];
    let positions = [1, 1, 1, 1];
    let turn = 0;
    let isHost = false;
    let myRole = 0;
    let maxPlayers = 2;

    function createBoard() {
        const wrapper = document.getElementById('game-wrapper');
        for (let row = 0; row < 10; row++) {
            for (let col = 0; col < 10; col++) {
                let num;
                // Traditional Snake Logic
                if (row % 2 === 0) {
                    num = (row * 10) + (col + 1);
                } else {
                    num = (row * 10) + (10 - col);
                }
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.id = 'cell-' + num;
                cell.innerText = num;
                wrapper.appendChild(cell);
            }
        }
    }

    const hash = window.location.hash.replace('#', '');
    if (hash) {
        isHost = false;
        document.getElementById('setup-controls').innerHTML = "Connecting to ritual...";
        peer = new Peer();
        peer.on('open', () => {
            const conn = peer.connect(hash);
            setupConn(conn);
        });
    }

    function initHost() {
        isHost = true;
        maxPlayers = parseInt(document.getElementById('max-players-select').value);
        peer = new Peer();
        peer.on('open', (id) => {
            document.getElementById('setup-controls').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
            document.getElementById('share-url').value = window.location.href + '#' + id;
            document.getElementById('player-count-display').innerText = `Souls: 1 / ${maxPlayers}`;
        });
        peer.on('connection', (c) => {
            conns.push(c);
            setupConn(c);
            document.getElementById('player-count-display').innerText = `Souls: ${conns.length + 1} / ${maxPlayers}`;
            if (conns.length === maxPlayers - 1) startGame();
        });
    }

    function setupConn(c) {
        c.on('data', (data) => {
            if (data.type === 'init') {
                myRole = data.role;
                maxPlayers = data.max;
                document.getElementById('setup-screen').style.display = 'none';
                updateUI();
            }
            if (data.type === 'game') {
                positions = data.positions;
                turn = data.turn;
                updateUI();
            }
        });
    }

    function startGame() {
        conns.forEach((c, i) => c.send({type: 'init', role: i + 1, max: maxPlayers}));
        document.getElementById('setup-screen').style.display = 'none';
        updateUI();
    }

    function handleRoll() {
        const roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-val').innerText = roll;
        
        let currentPos = positions[myRole];
        let nextPos = currentPos + roll;

        // Bouncing logic
        if (nextPos > 100) {
            let overflow = nextPos - 100;
            nextPos = 100 - overflow;
        }

        positions[myRole] = nextPos;
        updateUI();

        if (nextPos === 100) {
            alert("YOU ESCAPED!");
            location.reload();
        } else if (nextPos > 1 && Math.random() > 0.5) {
            setTimeout(triggerSurprise, 500);
        } else {
            finishTurn();
        }
    }

    function triggerSurprise() {
        const surprises = [
            {t: "GHOST PUSH! Back 7 steps.", m: -7},
            {t: "DARK ENERGY! Forward 10 steps.", m: 10},
            {t: "THE VOID! Reset to cell 1.", abs: 1}
        ];
        const s = surprises[Math.floor(Math.random() * surprises.length)];
        document.getElementById('event-text').innerText = s.t;
        document.getElementById('overlay').style.display = 'flex';
        
        if (navigator.vibrate) navigator.vibrate(400);

        if (s.abs) positions[myRole] = s.abs;
        else {
            positions[myRole] = Math.max(1, Math.min(99, positions[myRole] + s.m));
        }
    }

    function finishTurn() {
        turn = (turn + 1) % maxPlayers;
        sync();
        updateUI();
    }

    function sync() {
        const payload = {type: 'game', positions, turn};
        if (isHost) conns.forEach(c => c.send(payload));
        else {
            // Re-connect to sync if connection lost
            const hostConn = peer.connect(hash);
            hostConn.on('open', () => hostConn.send(payload));
        }
    }

    function updateUI() {
        document.getElementById('status').innerText = (turn === myRole) ? "YOUR TURN" : `P${turn+1}'s TURN`;
        document.getElementById('roll-btn').disabled = (turn !== myRole);
        document.getElementById('my-id-display').innerText = `You are Player ${myRole + 1}`;
        
        document.querySelectorAll('.player').forEach(p => p.remove());
        positions.slice(0, maxPlayers).forEach((pos, i) => {
            const cell = document.getElementById('cell-' + pos);
            if(cell) {
                const p = document.createElement('div');
                p.className = `player p${i}`;
                cell.appendChild(p);
            }
        });
    }

    function closeOverlay() {
        document.getElementById('overlay').style.display = 'none';
        finishTurn();
    }

    createBoard();
</script>
</body>
</html>
