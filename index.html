<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 GATES: RECOVERY MODE</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #050505; --accent: #8b0000; --panel: #1a1a1a; }
        * { box-sizing: border-box; font-family: 'Courier New', monospace; }
        body { background: var(--bg); color: #ddd; margin: 0; padding: 5px; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
        
        /* Loading Screen */
        #loading-screen {
            position: fixed; top:0; left:0; width:100%; height:100%; background: #000;
            z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #game-wrapper { width: 95vw; max-width: 450px; aspect-ratio: 1/1; border: 5px solid #222; display: flex; flex-wrap: wrap-reverse; background: #111; }
        .cell { width: 10%; height: 10%; border: 0.5px solid #222; display: flex; align-items: center; justify-content: center; font-size: 9px; color: #444; position: relative; }
        .player { width: 16px; height: 16px; border-radius: 50%; position: absolute; z-index: 10; border: 2px solid #fff; transition: all 0.4s ease; }
        .p0 { background: red; } .p1 { background: cyan; } .p2 { background: lime; } .p3 { background: yellow; }
        
        .panel { background: var(--panel); padding: 15px; border-radius: 8px; text-align: center; width: 95%; max-width: 450px; margin-top: 10px; }
        button { background: var(--accent); color: white; border: none; padding: 18px; cursor: pointer; font-weight: bold; width: 100%; border-radius: 5px; font-size: 18px; }
        button:disabled { background: #222; color: #444; }
        
        .setup-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 4000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p id="loading-text" style="color: var(--accent); margin-top: 20px;">SUMMONING SERVER...</p>
    </div>

    <div id="setup-screen" class="setup-screen">
        <h1 style="color:var(--accent)">100 GATES</h1>
        <div id="setup-controls">
            <select id="max-players-select" style="padding:10px; margin:10px; background:#111; color:white;">
                <option value="2">2 PLAYERS</option>
                <option value="3">3 PLAYERS</option>
                <option value="4">4 PLAYERS</option>
            </select><br>
            <button onclick="initHost()">HOST RITUAL</button>
        </div>
        <div id="waiting-area" style="display:none; text-align: center;">
            <p>SEND THIS LINK TO FRIENDS:</p>
            <input type="text" id="share-url" style="width:100%; padding:10px; background:#111; color:red;" readonly onclick="this.select()">
            <p id="player-count-display" style="color:red; font-size: 20px; margin-top: 20px;"></p>
        </div>
    </div>

    <div id="status" style="color:yellow; font-size: 12px; margin: 5px;">AWAITING SOULS...</div>
    <div id="game-wrapper"></div>

    <div class="panel">
        <div id="dice-val" style="font-size: 30px; margin-bottom: 5px;">ðŸŽ²</div>
        <button id="roll-btn" onclick="handleRoll()" disabled>ROLL DICE</button>
    </div>

<script>
    let peer, conns = [];
    let positions = [1, 1, 1, 1], turn = 0, isHost = false, myRole = 0, maxPlayers = 2;
    let sounds = { bg: null, jump: null, dice: null };

    // SHOW LOADING
    function showLoading(msg) {
        document.getElementById('loading-screen').style.display = 'flex';
        document.getElementById('loading-text').innerText = msg;
    }

    function hideLoading() {
        document.getElementById('loading-screen').style.display = 'none';
    }

    // FIREWALL BYPASS CONFIG
    const peerConfig = {
        config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' }, { url: 'stun:stun1.l.google.com:19302' }]}
    };

    // LAZY AUDIO LOAD (Doesn't block game)
    function tryLoadAudio() {
        try {
            sounds.bg = new Audio('horrorsound.mp3'); sounds.bg.loop = true; sounds.bg.volume = 0.2;
            sounds.jump = new Audio('jump.mp3');
            sounds.dice = new Audio('dice.mp3');
            sounds.bg.play().catch(() => console.log("Audio needs click"));
        } catch(e) { console.log("Audio files missing - continuing without sound"); }
    }

    const hash = window.location.hash.replace('#', '');
    if (hash) {
        document.getElementById('setup-controls').innerHTML = `<button onclick="initGuest()">JOIN RITUAL</button>`;
    }

    function initHost() {
        isHost = true;
        maxPlayers = parseInt(document.getElementById('max-players-select').value);
        showLoading("OPENING GATES...");
        
        peer = new Peer(peerConfig);
        peer.on('open', (id) => {
            hideLoading();
            document.getElementById('setup-controls').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
            document.getElementById('share-url').value = window.location.href.split('#')[0] + '#' + id;
            document.getElementById('player-count-display').innerText = `SOULS: 1 / ${maxPlayers}`;
            tryLoadAudio();
        });

        peer.on('connection', (c) => {
            conns.push(c);
            setupConn(c);
            document.getElementById('player-count-display').innerText = `SOULS: ${conns.length + 1} / ${maxPlayers}`;
            if (conns.length === maxPlayers - 1) startGame();
        });

        peer.on('error', (err) => { alert("Host Error: " + err.type); hideLoading(); });
    }

    function initGuest() {
        showLoading("CONNECTING TO HOST...");
        peer = new Peer(peerConfig);
        peer.on('open', () => {
            const conn = peer.connect(hash, {reliable: true});
            setupConn(conn);
            tryLoadAudio();
        });
        peer.on('error', (err) => { alert("Join Error: " + err.type); hideLoading(); });
    }

    function setupConn(c) {
        c.on('open', () => {
            hideLoading();
            if(!isHost) document.getElementById('status').innerText = "CONNECTED";
        });
        c.on('data', (data) => {
            if (data.type === 'init') {
                myRole = data.role; maxPlayers = data.max;
                document.getElementById('setup-screen').style.display = 'none';
                updateUI();
            }
            if (data.type === 'game') {
                positions = data.positions; turn = data.turn;
                updateUI();
            }
        });
    }

    function startGame() {
        conns.forEach((c, i) => c.send({type: 'init', role: i + 1, max: maxPlayers}));
        document.getElementById('setup-screen').style.display = 'none';
        updateUI();
    }

    function handleRoll() {
        if(sounds.dice) sounds.dice.play();
        const roll = Math.floor(Math.random() * 6) + 1;
        document.getElementById('dice-val').innerText = roll;
        let nextPos = positions[myRole] + roll;
        if (nextPos > 100) nextPos = 100 - (nextPos - 100);
        positions[myRole] = nextPos;
        updateUI();
        if (nextPos === 100) { alert("YOU ESCAPED!"); location.reload(); }
        else finishTurn();
    }

    function finishTurn() {
        turn = (turn + 1) % maxPlayers;
        sync();
        updateUI();
    }

    function sync() {
        const payload = {type: 'game', positions, turn};
        if (isHost) conns.forEach(c => c.send(payload));
        else {
            const hostConn = peer.connect(hash);
            hostConn.on('open', () => hostConn.send(payload));
        }
    }

    function updateUI() {
        document.getElementById('status').innerText = (turn === myRole) ? "YOUR TURN" : "WAITING...";
        document.getElementById('roll-btn').disabled = (turn !== myRole);
        document.querySelectorAll('.player').forEach(p => p.remove());
        positions.slice(0, maxPlayers).forEach((pos, i) => {
            const cell = document.getElementById('cell-' + pos);
            if(cell) {
                const p = document.createElement('div');
                p.className = `player p${i}`; cell.appendChild(p);
            }
        });
    }

    function createBoard() {
        const wrapper = document.getElementById('game-wrapper');
        for (let row = 0; row < 10; row++) {
            for (let col = 0; col < 10; col++) {
                let num = (row % 2 === 0) ? (row * 10) + (col + 1) : (row * 10) + (10 - col);
                const cell = document.createElement('div');
                cell.className = 'cell'; cell.id = 'cell-' + num; cell.innerText = num;
                wrapper.appendChild(cell);
            }
        }
    }

    createBoard();
</script>
</body>
</html>
